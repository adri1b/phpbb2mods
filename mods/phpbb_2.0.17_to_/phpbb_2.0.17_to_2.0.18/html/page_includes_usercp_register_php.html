<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en" dir="ltr">
<head>
<meta http-equiv="Content-Type" content="text/html">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>includes/usercp_register.php</title>
<link rel="stylesheet" type="text/css" href="css/styles.css" />
</head>
<body bgcolor="#FFFFFF" text="#000000" link="#006699" vlink="#006699">
<script type="text/javascript" src="js/toggle_frame.js"></script>
<script type="text/javascript"><!--
toggle_frame.init(
	['images/toggle_frame_hide.gif','images/toggle_frame_show.gif'],
	['Hide Navigation!','Show Navigation!']
);
//--></script>
<table cellpadding="10" cellspacing="0" border="0" width="100%">
	<tr>
		<td>
			<table cellpadding="10" cellspacing="0" border="0" width="100%" class="bodyline">
				<tr>
					<td align="center" colspan="2"><span class="maintitle">includes/usercp_register.php</span></td>
				</tr>
			</table>
		</td>
	</tr>
</table>
<script type="text/javascript" src="js/select_onclick.js"></script>
<script type="text/javascript" src="js/dom_page_state.js"></script>
<script type="text/javascript"><!--
select_onclick.init(
	'Click me to select the text!'
);
dom_page_state.init(
	'action_2528',
	['buttonswrapper','buttoncheckoff','buttoncheckon'],
	['checkmousedown','checkmouseup']
);
//--></script>
<table cellpadding="10" cellspacing="0" border="0" width="100%">
	<tr>
		<td>
			<ul>
			<li><h3 class="h3">FIND:</h3>
				<pre class="code" id="code0">$error = FALSE;
</pre>
			</li>
			<li><h3 class="h3">AFTER, ADD:</h3>
				<pre class="code" id="code1">$error_msg = '';
</pre>
			</li>
			<li><h3 class="h3">FIND:</h3>
				<pre class="code" id="code2">		$attachsig = ( isset($HTTP_POST_VARS['attachsig']) ) ? ( ($HTTP_POST_VARS['attachsig']) ? TRUE : 0 ) : 0;
</pre>
			</li>
			<li><h3 class="h3">REPLACE WITH:</h3>
				<pre class="code" id="code3">		$attachsig = ( isset($HTTP_POST_VARS['attachsig']) ) ? ( ($HTTP_POST_VARS['attachsig']) ? TRUE : 0 ) : $userdata['user_attachsig'];
</pre>
			</li>
			<li><h3 class="h3">FIND:</h3>
				<pre class="code" id="code4">	$user_avatar_local = ( isset($HTTP_POST_VARS['avatarselect']) &amp;&amp; !empty($HTTP_POST_VARS['submitavatar']) &amp;&amp; $board_config['allow_avatar_local'] ) ? htmlspecialchars($HTTP_POST_VARS['avatarselect']) : ( ( isset($HTTP_POST_VARS['avatarlocal'])  ) ? htmlspecialchars($HTTP_POST_VARS['avatarlocal']) : '' );
</pre>
			</li>
			<li><h3 class="h3">AFTER, ADD:</h3>
				<pre class="code" id="code5">	$user_avatar_category = ( isset($HTTP_POST_VARS['avatarcatname']) &amp;&amp; $board_config['allow_avatar_local'] ) ? htmlspecialchars($HTTP_POST_VARS['avatarcatname']) : '' ;
</pre>
			</li>
			<li><h3 class="h3">FIND:</h3>
				<pre class="code" id="code6">	$user_avatar = ( empty($user_avatar_loc) &amp;&amp; $mode == 'editprofile' ) ? $userdata['user_avatar'] : '';
	$user_avatar_type = ( empty($user_avatar_loc) &amp;&amp; $mode == 'editprofile' ) ? $userdata['user_avatar_type'] : '';
</pre>
			</li>
			<li><h3 class="h3">REPLACE WITH:</h3>
				<pre class="code" id="code7">	$user_avatar = ( empty($user_avatar_local) &amp;&amp; $mode == 'editprofile' ) ? $userdata['user_avatar'] : '';
	$user_avatar_type = ( empty($user_avatar_local) &amp;&amp; $mode == 'editprofile' ) ? $userdata['user_avatar_type'] : '';
</pre>
			</li>
			<li><h3 class="h3">FIND:</h3>
				<pre class="code" id="code8">		$signature = stripslashes($signature);
</pre>
			</li>
			<li><h3 class="h3">REPLACE WITH:</h3>
				<pre class="code" id="code9">		$signature = htmlspecialchars(stripslashes($signature));
</pre>
			</li>
			<li><h3 class="h3">FIND:</h3>
				<pre class="code" id="code10">			$user_avatar = $user_avatar_local;
</pre>
			</li>
			<li><h3 class="h3">REPLACE WITH:</h3>
				<pre class="code" id="code11">			$user_avatar = $user_avatar_category . '/' . $user_avatar_local;
</pre>
			</li>
			<li><h3 class="h3">FIND:</h3>
				<pre class="code" id="code12">		if ( $signature_bbcode_uid == '' )
</pre>
			</li>
			<li><h3 class="h3">REPLACE WITH:</h3>
				<pre class="code" id="code13">		if ( !isset($signature_bbcode_uid) || $signature_bbcode_uid == '' )
</pre>
			</li>
			<li><h3 class="h3">FIND:</h3>
				<pre class="code" id="code14">		if ( @file_exists(@phpbb_realpath('./' . $board_config['avatar_path'] . '/' . $userdata['user_avatar'])) )
		{
			@unlink(@phpbb_realpath('./' . $board_config['avatar_path'] . '/' . $userdata['user_avatar']));
		}
</pre>
			</li>
			<li><h3 class="h3">REPLACE WITH:</h3>
				<pre class="code" id="code15">		user_avatar_delete($userdata['user_avatar_type'], $userdata['user_avatar']);
</pre>
			</li>
			<li><h3 class="h3">FIND:</h3>
				<pre class="code" id="code16">		if ( @file_exists(@phpbb_realpath('./' . $board_config['avatar_path'] . '/' . $userdata['user_avatar'])) )
		{
			@unlink(@phpbb_realpath('./' . $board_config['avatar_path'] . '/' . $userdata['user_avatar']));
		}
		$avatar_sql = user_avatar_gallery($mode, $error, $error_msg, $user_avatar_local);
</pre>
			</li>
			<li><h3 class="h3">REPLACE WITH:</h3>
				<pre class="code" id="code17">		user_avatar_delete($userdata['user_avatar_type'], $userdata['user_avatar']);
		$avatar_sql = user_avatar_gallery($mode, $error, $error_msg, $user_avatar_local, $user_avatar_category);
</pre>
			</li>
			<li><h3 class="h3">FIND:</h3>
				<pre class="code" id="code18">				$emailer-&gt;from($board_config['board_email']);
				$emailer-&gt;replyto($board_config['board_email']);

				$emailer-&gt;use_template('user_activate', stripslashes($user_lang));
				$emailer-&gt;email_address($email);
				$emailer-&gt;set_subject($lang['Reactivate']);

				$emailer-&gt;assign_vars(array(
					'SITENAME' =&gt; $board_config['sitename'],
					'USERNAME' =&gt; preg_replace($unhtml_specialchars_match, $unhtml_specialchars_replace, substr(str_replace(&quot;\'&quot;, &quot;'&quot;, $username), 0, 25)),
					'EMAIL_SIG' =&gt; (!empty($board_config['board_email_sig'])) ? str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $board_config['board_email_sig']) : '',

					'U_ACTIVATE' =&gt; $server_url . '?mode=activate&amp;' . POST_USERS_URL . '=' . $user_id . '&amp;act_key=' . $user_actkey)
				);
				$emailer-&gt;send();
				$emailer-&gt;reset();
</pre>
			</li>
			<li><h3 class="h3">REPLACE WITH:</h3>
				<pre class="code" id="code19"> 				if ( $board_config['require_activation'] != USER_ACTIVATION_ADMIN )
 				{
 					$emailer-&gt;from($board_config['board_email']);
 					$emailer-&gt;replyto($board_config['board_email']);
 
 					$emailer-&gt;use_template('user_activate', stripslashes($user_lang));
 					$emailer-&gt;email_address($email);
 					$emailer-&gt;set_subject($lang['Reactivate']);
  
 					$emailer-&gt;assign_vars(array(
 						'SITENAME' =&gt; $board_config['sitename'],
 						'USERNAME' =&gt; preg_replace($unhtml_specialchars_match, $unhtml_specialchars_replace, substr(str_replace(&quot;\'&quot;, &quot;'&quot;, $username), 0, 25)),
 						'EMAIL_SIG' =&gt; (!empty($board_config['board_email_sig'])) ? str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $board_config['board_email_sig']) : '',
  
 						'U_ACTIVATE' =&gt; $server_url . '?mode=activate&amp;' . POST_USERS_URL . '=' . $user_id . '&amp;act_key=' . $user_actkey)
 					);
 					$emailer-&gt;send();
 					$emailer-&gt;reset();
 				}
 				else if ( $board_config['require_activation'] == USER_ACTIVATION_ADMIN )
 				{
 					$sql = 'SELECT user_email, user_lang 
 						FROM ' . USERS_TABLE . '
 						WHERE user_level = ' . ADMIN;
 					
 					if ( !($result = $db-&gt;sql_query($sql)) )
 					{
 						message_die(GENERAL_ERROR, 'Could not select Administrators', '', __LINE__, __FILE__, $sql);
 					}
 					
 					while ($row = $db-&gt;sql_fetchrow($result))
 					{
 						$emailer-&gt;from($board_config['board_email']);
 						$emailer-&gt;replyto($board_config['board_email']);
 						
 						$emailer-&gt;email_address(trim($row['user_email']));
 						$emailer-&gt;use_template(&quot;admin_activate&quot;, $row['user_lang']);
 						$emailer-&gt;set_subject($lang['Reactivate']);
 
 						$emailer-&gt;assign_vars(array(
 							'USERNAME' =&gt; preg_replace($unhtml_specialchars_match, $unhtml_specialchars_replace, substr(str_replace(&quot;\'&quot;, &quot;'&quot;, $username), 0, 25)),
 							'EMAIL_SIG' =&gt; str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $board_config['board_email_sig']),
 
 							'U_ACTIVATE' =&gt; $server_url . '?mode=activate&amp;' . POST_USERS_URL . '=' . $user_id . '&amp;act_key=' . $user_actkey)
 						);
 						$emailer-&gt;send();
 						$emailer-&gt;reset();
 					}
 					$db-&gt;sql_freeresult($result);
 				}
</pre>
			</li>
			<li><h3 class="h3">FIND:</h3>
				<pre class="comment"> NOTE --- This is a partial match, the whole line on a fresh installation looks like this:
	display_avatar_gallery($mode, $avatar_category, $user_id, $email, $current_email, $coppa, $username, $email, &amp;$new_password, &amp;$cur_password, $password_confirm, $icq, $aim, $msn, $yim, $website, $location, $occupation, $interests, $signature, $viewemail, $notifypm, $popup_pm, $notifyreply, $attachsig, $allowhtml, $allowbbcode, $allowsmilies, $allowviewonline, $user_style, $user_lang, $user_timezone, $user_dateformat, $userdata['session_id']);</pre>
				<pre class="code" id="code20">	display_avatar_gallery($mode,
</pre>
			</li>
			<li><h3 class="h3">IN-LINE FIND:</h3>
				<pre class="code" id="code21">&amp;$new_password, &amp;$cur_password
</pre>
			</li>
			<li><h3 class="h3">IN-LINE REPLACE WITH:</h3>
				<pre class="code" id="code22">$new_password, $cur_password
</pre>
			</li>
			<li><h3 class="h3">FIND:</h3>
				<pre class="code" id="code23">	if ( !isset($user_template) )
	{
		$selected_template = $board_config['system_template'];
	}
</pre>
			</li>
			<li><h3 class="h3">REPLACE WITH:</h3>
				<pre class="code" id="code24">	if ( !isset($user_style) )
	{
		$user_style = $board_config['default_style'];
	}
</pre>
			</li>
			<li><h3 class="h3">FIND:</h3>
				<pre class="code" id="code25">		$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;avatarlocal&quot; value=&quot;' . $user_avatar_local . '&quot; /&gt;';
</pre>
			</li>
			<li><h3 class="h3">REPLACE WITH:</h3>
				<pre class="code" id="code26">		$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;avatarlocal&quot; value=&quot;' . $user_avatar_local . '&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;avatarcatname&quot; value=&quot;' . $user_avatar_category . '&quot; /&gt;';
</pre>
			</li>
			</ul>
		</td>
	</tr>
</table>
<div id="buttonswrapper" style="display:none;"><table cellpadding="10" cellspacing="0" border="0" width="100%">
	<tr>
		<td align="center">
			<img src="images/spacer.gif" width="1" height="40" alt="" />
			<hr /><br />
			<div id="buttoncheckoff" class="checkmouseup" style="display:none;">Mark as Unprocessed <img src="images/icon_check_off.gif" border="0" alt="" /></div>
			<div id="buttoncheckon"  class="checkmouseup" style="display:none;">Mark as Processed <img src="images/icon_check_on.gif" border="0" alt="" /></div>
		</td>
	</tr>
</table></div>
<div style="margin:10px;"><hr /><div class="copyright" style="text-align:center;">Copyright &copy; phpBB Group, 2005, All Rights Reserved</div></div>
</body>
</html>
