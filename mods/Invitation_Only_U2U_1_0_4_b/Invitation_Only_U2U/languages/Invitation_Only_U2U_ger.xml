<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.subsilver.de.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.0.xsd">
  <header>
    <license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
    <title lang="en-gb">Invitation Only U2U ("Gmail invites") phpBB.de - Edition</title>
    <description lang="en-gb">
		This MOD was submitted to the MOD Contest on  http://www.phpbb.de/.
		This is an U2U (User to User) Invite mod with a limiting character, as opposed to referral
		mods where attracting users is the objective.

	</description>
	<description lang="de-DE">
		Die Invitation Only U2U Mod ist eine Weiterentwicklung der bekannten "Invitation Only" Mod.
		Die Idee ist es, Registrierungen von uneingeladenen Besuchern zu unterbinden. Dafür wird
		den registrierten Nutzern die Möglichkeit gegeben Bekannte einzuladen.
		Abgerunded wird die Mod durch zahlreiche Features für Gruppen und ein mächtiges Admininterface.
	</description>
	<author-notes lang="en-GB">
		Special thanks to the phpbb.de Team for the contest-the mod would not exist without it.
		Also thanks to the phpBB team for obvious reasons and to wGEric for the insert_pm function.
		Please use Easymod for the installation(The SQL part might need manual installation).
			Only tested with MySQL4.



		User features include:
		-email invites (with a limited number of invites available)
		-email invites on behalf of a group(for Group Moderators)

		Admin featurs include:
		-create invites
		-explore invites (who was invited by whom)
		-(re-)send invitation mails
		-give invites to users (all/group-membes/rank/registration date)
		-give invites to groups
		-auto-group members based on their invitation-code(during registration)
		-invitation settings : off/optional/mandatory
		-send-invite settings: All/Admins only.


		This is an advanced Version of the "Invitation Only" Mod.
		While it may look like overkill for small private boards, it still can be set to behave just like "Invitation Only".
		In fact, this mod should scale better and be easier to maintain, without being harder to install. The main downside
		of this mod are the altered tables - "Invitation Only" left the original phpbb tables untouched.

		Differences to "Invitation Only"
		-should be easier to maintain
		-better Performance in Admin
		-User to (future) User invites
		-Invite Explore Mode
		-Resend emails
		-auto-activate Group-membership
		-PM notification about accepted invites
		-can be set to "optional"
		-many minor improvements

		Downsides:
		-less informative invitation list (performance reasons)
		-Alters user and groups table (I considered only altering the Group table, but that approach didn't scale well)
		-more changes to templates


		What does it NOT ?:
		-bulk mail.
		-link with a cash mod. It has no interface to any cash mod. (feel free to add one ;-) )
		-invite members already registered into usergroups.
	</author-notes>
	<author-notes lang="de-DE">
		Diese Mod enstand im Rahmen des 2005er phpBB.de Mod Wettbewerbs. Ich empfehle dringend die Installation mit Easymod.
	 
		Nutzer können:
			- Feunde per email einladen (begrenzte Anzahl)
			- Als Gruppenmoderatoren per email im Namen einer Gruppe einladen (begrenzte Anzahl)

		Admins können:
			-Einladungen versenden (unbegrenzt)
			-Einladunggen verfolgen
			-Einladungen erneut versenden
			-Den Kontostand der Nutzer verändern  
			-Codes Gruppen zuordnen
			-Die Mod Deaktivieren oder auf Optional setzten
			-Den Infotext bei der Registrierung anpassen
			

		Die Mod ist eine Weiterentwicklung der Invitation Only Mod. Sie sollte besser mit grossen Boards funktionieren, 
		lässt aber die Tabellen  von phpBB nicht unverändert.
	</author-notes>
    <author-group>
      <author>
        <realname>available on request</realname>
        <email>kellanved@gmail.com</email>
        <username>Kellanved</username>
        <contributions />
      </author>
    </author-group>
    <mod-version>
      <major>1</major>
      <minor>0</minor>
      <revision>4</revision>
	  <release>a</release>
    </mod-version>
    <installation>
      <level>intermediate</level>
      <time>2700</time>
      <target-version>
        <target-primary>2.0</target-primary>
        <target-major allow="exact">2</target-major>
        <target-minor allow="exact">0</target-minor>
      </target-version>
    </installation>
    <history>
      <entry>
        <date>2005-08-01</date>
        <rev-version>
          <major>0</major>
          <minor>1</minor>
          <revision>0</revision>
        </rev-version>
        <changelog lang="en-GB">
          <change> initial English Beta</change>
        </changelog>
		 <changelog lang="de-DE">
          <change> erste Beta</change>
        </changelog>
      </entry>
      <entry>
        <date>2005-08-02</date>
        <rev-version>
          <major>0</major>
          <minor>1</minor>
          <revision>1</revision>
        </rev-version>
        <changelog lang="en-GB">
          <change>Added a link in the groupcp</change>
        </changelog>
		<changelog lang="de-DE">
          <change>verbesserte Gruppenfunktionen</change>
        </changelog>
      </entry>
      <entry>
        <date>2005-08-02</date>
        <rev-version>
          <major>0</major>
          <minor>1</minor>
          <revision>2</revision>
        </rev-version>
        <changelog lang="en-GB">
          <change>initial German Beta</change>
          <change>added a few shortcuts</change>
          <change>several Bugs fixed (wrong lang fields and a few quirks in the Mod template) .</change>
        </changelog>
		<changelog lang="de-DE">
          <change>erste deutsche Version</change>
          <change>Teile enger verbunden</change>
          <change>diverse Fehler behoben.</change>
        </changelog>
      </entry>
      <entry>
        <date>2005-08-13</date>
        <rev-version>
          <major>1</major>
          <minor>0</minor>
          <revision>0</revision>
        </rev-version>
        <changelog lang="en-GB">
          <change>fixed several bugs</change>
          <change>moved the invitation use inside the register transaction</change>
          <change>the confirmation now gets send, even if sending the mail fails</change>
          <change>... a few minor changes.</change>
        </changelog>
		<changelog lang="de-DE">
          <change>abermals mehrere Bugs behoben</change>
          <change>Anordnung der Datenbankanfragen verändert</change>
          <change>Bestätigung wird nun auch bei Fehlschlag gesendet</change>
          <change>dieses und jenes</change>
        </changelog>
      </entry>
      <entry>
        <date>2005-09-15</date>
        <rev-version>
          <major>1</major>
          <minor>0</minor>
          <revision>0</revision>
        </rev-version>
        <changelog lang="en-GB">
          <change> two bugs fixed</change>
        </changelog>
		<changelog lang="de-DE">
          <change>noch zwei Käfer</change>
        </changelog>
      </entry>
       
      <entry>
        <date>2005-12-03</date>
        <rev-version>
          <major>1</major>
          <minor>0</minor>
          <revision>0</revision>
        </rev-version>
        <changelog lang="en-GB">
          <change>minor changes</change>
        </changelog>
		<changelog lang="de-DE">
          <change>Detailverbesserungen</change>
        </changelog>
      </entry>
      <entry>
        <date>2005-12-07</date>
        <rev-version>
          <major>1</major>
          <minor>0</minor>
          <revision>0</revision>
        </rev-version>
        <changelog lang="en-GB">
          <change>should resolve problems with the French translation</change>
        </changelog>
		<changelog lang="de-DE">
          <change>Textbehandlung bereinigt</change>
        </changelog>
      </entry>
      <entry>
        <date>2006-03-06</date>
        <rev-version>
          <major>1</major>
          <minor>0</minor>
          <revision>0</revision>
        </rev-version>
        <changelog lang="en-GB">
          <change>phpBB 2.0.19 compatibility</change>
          <change>several HTML issues</change>
          <change>a few SQL issues</change>
        </changelog>
		<changelog lang="de-DE">
          <change>phpBB 2.0.19 Kompatibilität</change>
          <change>HTML Fehler behoben</change>
          <change>MYSQL 5 Probleme (hoffentlich) gelöst</change>
        </changelog>
      </entry>
      <entry>
        <date>2006-03-28</date>
        <rev-version>
          <major>1</major>
          <minor>0</minor>
          <revision>3</revision>
          <release>a</release>
        </rev-version>
        <changelog lang="en-GB">
          <change> general clean up, as suggested by Mac (mostly HTML) </change>
        </changelog>
		 <changelog lang="de-DE">
          <change> Abermals HTML gereinigt</change>
        </changelog>
      </entry>
	  <entry>
        <date>2006-04-12</date>
        <rev-version>
          <major>1</major>
          <minor>0</minor>
          <revision>3</revision>
          <release>c</release>
        </rev-version>
        <changelog lang="en-GB">
          <change> Missing "Auto Activate" string fixed </change>
		  <change> ModX file (German/English) </change>
        </changelog>
		 <changelog lang="de-DE">
          <change> Fehlenden "Automatisch Aktivieren" String ergänzt</change>
		  <change> ModX Datei ergänzt (Deutsch/English) </change>
        </changelog>
      </entry>
	  <entry>
        <date>2006-06-10</date>
        <rev-version>
          <major>1</major>
          <minor>0</minor>
          <revision>4</revision>
        </rev-version>
        <changelog lang="en-GB">
          <change> Fixed pagination on admin list.</change>
		  <change> Fixed Link in groupcp. </change>
		  <change> Added config setting for confirmation PM. </change>
		  <change> Added config setting for confirmation Mail. </change>
		  <change> Added config setting for acceptance PM. </change>
        </changelog>
		 <changelog lang="de-DE">
          <change> Die Liste im ACP wird nun korrekt auf mehrere Seiten verteilt.</change>
		  <change> Link im Groupcp funktioniert nun </change>
		  <change> Bestätigungs-PNs können nun abgestellt werden. </change> 
		  <change> Bestätigungs-Emailss können nun abgestellt werden. </change> 
		  <change> Registrierungs-PNs können nun abgestellt werden. </change> 
        </changelog>
      </entry>
	  <entry>
        <date>2006-07-09</date>
        <rev-version>
          <major>1</major>
          <minor>0</minor>
          <revision>4</revision>
		  <release>a</release>
        </rev-version>
        <changelog lang="en-GB">
          <change> Added Page Constant.</change>		   
        </changelog>
		 <changelog lang="de-DE">
          <change> Verwendet nun eine Page Constant.</change>
        </changelog>
      </entry>
    </history>
  </header>
  <action-group>
    <sql>CREATE TABLE phpbb_invitations (
	invitation_id MEDIUMINT( 8 ) NOT NULL AUTO_INCREMENT ,
	invitation_code VARCHAR( 8 ) NOT NULL ,
	invitation_description TEXT NOT NULL,
	invitation_uses MEDIUMINT( 8 ) NOT NULL DEFAULT '1',
	invitation_sender MEDIUMINT( 8 ) NOT NULL DEFAULT '0',
	invitation_group MEDIUMINT( 8 ) NOT NULL DEFAULT '0',
	invitation_group_auto_activate TINYINT( 1 ) NOT NULL DEFAULT '0',
	invitation_email TEXT NOT NULL,
	PRIMARY KEY ( invitation_id ) 
);

CREATE TABLE phpbb_invitation_users (
	invitation_id MEDIUMINT( 8 ) NOT NULL,
	user_id MEDIUMINT( 8 ) NOT NULL,	
	PRIMARY KEY ( user_id ) 
);	

INSERT INTO phpbb_config ( config_name , config_value ) 
	VALUES ('invitation_only', '2');
	
INSERT INTO phpbb_config ( config_name , config_value ) 
	VALUES ('invite_u2u', '2');

INSERT INTO phpbb_config ( config_name , config_value ) 
	VALUES ('additional_rules', '');
	
INSERT INTO phpbb_config ( config_name , config_value ) 
	VALUES ('send_invit_accept_pm', '1');
	
INSERT INTO phpbb_config ( config_name , config_value ) 
	VALUES ('send_invit_confirm_mail', '1');
 
INSERT INTO phpbb_config ( config_name , config_value ) 
	VALUES ('send_invit_confirm_pm', '1');
 
ALTER TABLE phpbb_users ADD user_invites MEDIUMINT( 8 ) NOT NULL DEFAULT '0';

ALTER TABLE phpbb_groups ADD group_invites MEDIUMINT( 8 ) NOT NULL DEFAULT '0';
	</sql>
    <copy>
      <file from="root/invite.php" to="invite.php" />
      <file from="root/includes/functions_invite.php" to="includes/functions_invite.php" />
      <file from="root/admin/admin_invites.php" to="admin/admin_invites.php"/>
      <file from="root/admin/admin_invites_config.php" to="admin/admin_invites_config.php" />
      <file from="root/admin/admin_invites_edit.php" to="admin/admin_invites_edit.php" />
      <file from="root/admin/admin_invites_list.php" to="admin/admin_invites_list.php" />
      <file from="root/language/lang_english/email/admin_send_invite_email.tpl" to="language/lang_english/email/admin_send_invite_email.tpl" />
      <file from="root/language/lang_english/email/user_send_invite_email.tpl" to=" language/lang_english/email/user_send_invite_email.tpl" />
	  <file from="root/language/lang_english/lang_invites.php" to=" language/lang_english/lang_invites.php" /> 
	  <file from="root/language/lang_english/lang_invites_admin.php" to=" language/lang_english/lang_invites_admin.php" />
	  <file from="translations/root/language/lang_german/email/admin_send_invite_email.tpl" to=" language/lang_german/email/admin_send_invite_email.tpl" />
      <file from="translations/root/language/lang_german/email/user_send_invite_email.tpl" to=" language/lang_german/email/user_send_invite_email.tpl" />
	  <file from="translations/root/language/lang_german/lang_invites.php" to="language/lang_german/lang_invites.php" />
      <file from="translations/root/language/lang_german/lang_invites_admin.php" to="language/lang_german/lang_invites_admin.php" />
      <file from="root/templates/subSilver/user_invite_add_body.tpl" to="templates/subSilver/user_invite_add_body.tpl" />
      <file from="root/templates/subSilver/invitation_only.tpl" to="templates/subSilver/invitation_only.tpl" />
      <file from="root/templates/subSilver/select_invite_role.tpl" to="templates/subSilver/select_invite_role.tpl" />
      <file from="root/templates/subSilver/images/mini_icon_invite.gif" to="templates/subSilver/images/mini_icon_invite.gif" />
      <file from="root/templates/subSilver/images/mini_icon_no_invites.gif" to="templates/subSilver/images/mini_icon_no_invites.gif" />
      <file from="root/templates/subSilver/admin/invite_add_body.tpl" to="templates/subSilver/admin/invite_add_body.tpl" />
      <file from="root/templates/subSilver/admin/invite_gen_tab2.tpl" to="templates/subSilver/admin/invite_gen_tab2.tpl" />
      <file from="root/templates/subSilver/admin/invite_generate.tpl" to="templates/subSilver/admin/invite_generate.tpl" />
      <file from="root/templates/subSilver/admin/invite_list_options.tpl" to="templates/subSilver/admin/invite_list_options.tpl" />
      <file from="root/templates/subSilver/admin/invites_config_body.tpl" to="templates/subSilver/admin/invites_config_body.tpl" />
      <file from="root/templates/subSilver/admin/invites_list_body.tpl" to="templates/subSilver/admin/invites_list_body.tpl" />
      <file from="root/templates/subSilver/admin/invites_list_invited.tpl" to="templates/subSilver/admin/invites_list_invited.tpl" />
      <file from="root/templates/subSilver/admin/invites_select_body.tpl" to="templates/subSilver/admin/invites_select_body.tpl" />
    </copy>
    <open src="includes/constants.php">
      <edit>
	    <find><![CDATA[define('PAGE_TOPIC_OFFSET', 5000);]]></find>
			<comment lang="en-GB">
				Reason: Custom Page Constant	
			</comment>
			<comment lang="de-DE">
				Reason: Custom Page Constant	
			</comment>
			<action type="after-add">
			<![CDATA[
	//BEGIN Invitation Only U2U MOD
	define('PAGE_INVITE', -1340);
	//END Invitation Only U2U MOD
		]]>
			</action>
	  </edit>
	  <edit>
        <find>define('VOTE_USERS_TABLE', $table_prefix.'vote_voters');</find>
		<comment lang="en-GB">
			Reason: adds the names of the new database tables to the constants.		
			Location (about): This should be the very last statement in the file .
		</comment>
		<comment lang="de-DE"> 
			Funktion: Definiert die Konstanten für die neuen Datenbank Tabellen
			Ort (Ungefähr): Dies sollte am Dateiende sein.
		</comment>
        <action type="after-add">
//BEGIN Invitation Only U2U MOD
define('INVITATION_TABLE', $table_prefix.'invitations');
define('INVITATION_USER_TABLE', $table_prefix.'invitation_users');
define('POST_INVITES_URL', 'i');
//END Invitation Only U2U MOD</action>
      </edit>
    </open>
	<open src="viewonline.php">
	 <edit>
        <find><![CDATA[				default:]]></find>
		<comment lang="en-GB">
			Funktion: Custom Page Constant	
		</comment>
		<comment lang="de-DE">
			Funktion: Custom Page Constant	
		</comment>
        <action type="before-add">
		<![CDATA[
				case PAGE_INVITE:
					$location = $lang['Inviting'];
					$location_url = "invite.$phpEx"; //We'll keep the location as index.
					break;
	]]>
	  	</action>
      </edit>
    </open>
    <open src="includes/usercp_register.php">
      <edit>
		  <comment lang="en-GB">
				Reason: Extends the function "show coopa" to forward the email and the invitation code	
				Location (about): Line 50
		  </comment>
		  <comment lang="de-DE"> 
				Funktion: Erweitert die Funktion "show coopa" (Altersabfrage), um den Code und die Emailadresse durchzuleiten.
				Ort (ungefähr): Zeile 50
		  </comment>
		  <find>function show_coppa()</find>
		  <inline-edit>
			  <inline-find>(</inline-find>
			  <inline-action type="after-add">$invite_code, $email</inline-action>
			</inline-edit>
      </edit>
      <edit>
	  
	    <comment lang="en-GB">
			Reason: Appends the variables to the link to the actual registration page.	
			Location (about): Line 65
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Ergänzt die Variablen zu dem Link zur eigentlichen Registrierungsseite.
			Ort (ungefähr): Zeile 65
	    </comment>
        <find><![CDATA["U_AGREE_OVER13" => append_sid("profile.$phpEx?mode=register&amp;agreed=true"),]]></find>
        <inline-edit>
          <inline-find>true"</inline-find>
          <inline-action type="after-add"> .$invite_code . $email</inline-action>
        </inline-edit>
      </edit>
      <edit>
	  
	    <comment lang="en-GB">
			Reason: Appends the variables to the link to the actual registration page.	
			Location (about): Line 66
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Ergänzt die Variablen zu dem Link zur eigentlichen Registrierungsseite.
			Ort (ungefähr): Zeile 66
	    </comment>
        <find><![CDATA[		"U_AGREE_UNDER13" => append_sid("profile.$phpEx?mode=register&amp;agreed=true&amp;coppa=true"))]]></find>
        <inline-edit>
          <inline-find>true"</inline-find>
          <inline-action type="after-add"> .$invite_code . $email</inline-action>
        </inline-edit>
      </edit>
      <edit>
	  
	    <comment lang="en-GB">
			Reason: Read the new variables.	
			Location (about): Line 79
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Die neuen Variablen für die Altersabfrage auslesen.
			Ort (ungefähr): Zeile 79
	    </comment>
        <find>
		<![CDATA[if ( $mode == 'register' && !isset($HTTP_POST_VARS['agreed']) && !isset($HTTP_GET_VARS['agreed']) )
{
	include($phpbb_root_path . 'includes/page_header.'.$phpEx);]]></find>
        <action type="after-add"><![CDATA[
	//BEGIN Invitation Only MOD
	if (!empty($HTTP_GET_VARS['invite'])||!empty($HTTP_POST_VARS['invite']))
	{
		$invite_code = htmlspecialchars((!empty($HTTP_GET_VARS['invite'])) ? $HTTP_GET_VARS['invite'] : $HTTP_POST_VARS['invite']);
		
		$invite_post = "&amp;invite=" .  urlencode($invite_code);
		
	}
	/*we could just as well retrieve the address from the database. But this gets the job done too. 
	(IMHO even better, as it can't be used to leak information))*/
	$email = ( !empty($HTTP_GET_VARS['email']) ) ? "&email=" .  urlencode($HTTP_GET_VARS['email']) :  '';
	$email = trim(htmlspecialchars($email));
	if ($board_config['invitation_only'] == 2 && empty($invite_code))
	{
		include($phpbb_root_path . 'includes/functions_invite.'.$phpEx);	    
		show_invitation_only();
	
	}
	else
	{
	 ]]></action>
      </edit>
      <edit>
	    
	    <comment lang="en-GB">
			Reason: Use the adapted show_coppa	
			Location (about): Line 83
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Die neue show_coppa Methode verwenden.
			Ort (ungefähr): Zeile 83
	    </comment>
        <find>show_coppa();</find>
        <inline-edit>
          <inline-find>(</inline-find>
          <inline-action type="after-add">$invite_post, $email</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find>include($phpbb_root_path . 'includes/page_tail.'.$phpEx);</find>
        <action type="before-add">
}
</action>
      </edit>
      <edit>
	  
	    <comment lang="en-GB">
			Reason: Incorporate the new fields in the registration form.
			Location (about): Line 110
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Die neuen Variablen für die Registrierungsseite.
			Ort (ungefähr): Zeile 110
	    </comment>
        <find><![CDATA[	$strip_var_list = array('email' => 'email', 'icq' => 'icq', 'aim' => 'aim', 'msn' => 'msn', 'yim' => 'yim']]></find>
        <inline-edit>
          <inline-find>)</inline-find>
          <inline-action type="before-add"><![CDATA[, 'invitation_code' => 'invitation_code']]></inline-action>
        </inline-edit>
      </edit>
      <edit>
	  
	    <comment lang="en-GB">
			Reason: If the Mod is active, check for a valid code.
			Location (about): Line 321
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Bei eingeschalteter Mod: eingegebenen Code überprüfen.
			Ort (ungefähr): Zeile 321
	    </comment>
        <find><![CDATA[			$db->sql_freeresult($result);
		}
	}
]]></find>
        <action type="after-add"><![CDATA[
	//BEGIN Invitation Only U2U MOD 
	$invite_data = false; 
	if ($board_config['invitation_only'] !=0 && $mode === 'register') //Let's check the invitation code they sent us
	{
		include($phpbb_root_path . "includes/functions_invite.$phpEx");
		if (empty($invitation_code) && $board_config['invitation_only'] == 2)
		{
			$error = TRUE;
			$error_msg .= ( ( isset($error_msg) ) ? '<br />' : '' ) . $lang['Invitation_code_invalid'];
		}
		if (!empty($invitation_code))
		{
			$invite_data = get_valid_invitation($invitation_code);
			if (!$invite_data)
			{
				$error = TRUE;
				$error_msg .= ( ( isset($error_msg) ) ? '<br />' : '' ) . $lang['Invitation_code_invalid'];
				$invite_data = false; 
			}
		} 
	}
	//END Invitation Only U2U MOD	
]]></action>
      </edit>
      <edit>
	   
	    <comment lang="en-GB">
			Reason: Store the use of the invite
			Location (about): Line 676
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Die VErwendung der Einladung abspeichern.
			Ort (ungefähr): Zeile 676
	    </comment>
        <find>			$email_template = 'user_welcome';
			}

			include($phpbb_root_path . 'includes/emailer.'.$phpEx);			 </find>
        <action type="after-add"><![CDATA[
			//BEGIN Invitation Only U2U MOD	 
				
			if ($board_config['invitation_only'] && !empty($invite_data) ) //OK, the code was good, let's update the invitation table 
			{  
				use_invite($invite_data, $user_id, $username);
			}
			//END Invitation Only U2U MOD 

]]></action>
      </edit>
      <edit>
	  
	    <comment lang="en-GB">
			Reason: The values for the extended form.
			Location (about): Line 1010
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Werte für das erweiterte Formular
			Ort (ungefähr): Zeile 1010
	    </comment>
        <find><![CDATA[		$template->assign_block_vars('switch_confirm', array());
	}]]></find>
        <action type="after-add"><![CDATA[
	//BEGIN Invitation Only U2U MOD 
	if (!empty($board_config['invitation_only']) && $mode == 'register')
	{
		$template->assign_block_vars('switch_invitation_only', array());
		$invitation_code = ( isset($HTTP_GET_VARS['invite']) ) ? trim($HTTP_GET_VARS['invite']) : ((isset($invitation_code)) ? $invitation_code : ''  ) ;
		$invitation_code = htmlspecialchars($invitation_code); 
		$email = ( isset($HTTP_GET_VARS['email']) ) ? trim($HTTP_GET_VARS['email']) : ((isset($email)) ? $email : ''  ) ;
		$email = htmlspecialchars($email); 
		$template->assign_vars(array(
			'INVITATION' => $invitation_code, 
			'L_INVITATION' => $lang['Invitation'],
			'L_INVITATION_EXPLAIN' => ($board_config['invitation_only']==1)? $lang['Invitation_optional'] : $lang['Invitation_mandantory'],
			'INVITATION_REQUIRED' => ($board_config['invitation_only']==2)? '*' : ''
		)); 
	}  
	//END Invitation Only U2U MOD]]></action>
      </edit>
    </open>
    <open src="includes/page_header.php">
      <edit>
	  	
	    <comment lang="en-GB">
			Reason: Infrastructure for the "invite a friend" in the header.
			Location (about): Line 341
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Infrastruktur für den Einladungsknopf.
			Ort (ungefähr): Zeile 341
	    </comment>
        <find><![CDATA[$l_timezone = (count($l_timezone) > 1 && $l_timezone[count($l_timezone)-1] != 0) ? $lang[sprintf('%.1f', $board_config['board_timezone'])] : $lang[number_format($board_config['board_timezone'])];]]></find>
        <action type="after-add"><![CDATA[
//BEGIN Invitation Only U2U MOD
if ( $userdata['session_logged_in']  && ($board_config['invite_u2u']))
{
	if ($board_config['invite_u2u'] == 2 || ($board_config['invite_u2u'] == 1 && $userdata['user_invites']))
	{
		if (!$userdata['user_invites'])
		{
			$invites_text = $lang['No_invites'];	   
		} 
		elseif ($userdata['user_invites'] == 1)
		{
			$invites_text = $lang['One_invite_left'];	   
		}
		else
		{
			$invites_text = $userdata['user_invites'] .' '.$lang['Invites_left'];	  
		} 
		 
		$template->assign_block_vars('switch_show_invites', array());
		$template->assign_vars(array(
			'L_INVITE_FRIEND' => $lang['Invite_a_friend'],
			'INVITES_LEFT' => $invites_text,
			'U_INVITE' => append_sid("invite.$phpEx",true)
		));
	}
}
//END Invitation Only U2U MOD]]></action>
      </edit>
    </open>
    <open src="templates/subSilver/overall_header.tpl">
      <edit>
	   <comment lang="en-GB">
			Reason: Extend the header.				 
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Der Knopf zur Einladungsseite.			 
	    </comment>
        <find><![CDATA[<!-- END switch_user_logged_out -->]]></find>
        <action type="after-add"><![CDATA[
						<!-- BEGIN switch_show_invites -->
						&nbsp;<a href="{U_INVITE}" class="mainmenu"><img src="templates/subSilver/images/mini_icon_invite.gif" width="12" height="13" border="0" alt="{L_INVITE_FRIEND}" hspace="3" />{L_INVITE_FRIEND}({INVITES_LEFT})</a></span>&nbsp;
						<!-- END switch_show_invites -->]]></action>
      </edit>
    </open>
    <open src="templates/subSilver/profile_add_body.tpl">
      <edit>
	    <comment lang="en-GB">
			Reason: The new fields in the registration form.			 
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Neue Felder im Registrierungsformular.
	    </comment>
        <find><![CDATA[<!-- END switch_confirm --> ]]></find>
        <action type="after-add"><![CDATA[
	<!-- BEGIN switch_invitation_only -->
	<tr>
		<td class="row1"><span class="gen">{L_INVITATION}: {INVITATION_REQUIRED} </span><br /><span class="gensmall">{L_INVITATION_EXPLAIN}</span></td>
		<td class="row2"><input type="text" class="post" style="width: 200px" name="invitation_code" size="8" maxlength="8" value="{INVITATION}" /></td>
	</tr>
	<!-- END switch_invitation_only -->]]></action>
      </edit>
    </open>
    <open src="admin/admin_users.php">
      <edit>
	   
	    <comment lang="en-GB">
			Reason: Keep the database tidy when a user gets deleted.	
			Location (about): Line 76
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Aufräumen, wenn ein Nutzer gelöscht wird.
			Ort (ungefähr): Zeile 76
	    </comment>
        <find>			$sql = "SELECT g.group_id </find>
        <action type="before-add"><![CDATA[
			//BEGIN Invitation Only U2U MOD
			// The user is no more; we do no longer need his/her invitation info. We couldn't use it anyway
			include($phpbb_root_path . 'includes/functions_invite.'.$phpEx);	    
			delete_user_invites($user_id);
			//END Invitation Only U2U MOD]]></action>
      </edit>
      <edit>
	  
	    <comment lang="en-GB">
			Reason: Add the field to set the user's invites.	
			Location (about): Line 285
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Ergänzt das Feld zur Bearbeitung des Einladungskontos.
			Ort (ungefähr): Zeile 285
	    </comment>
        <find>		$user_allowavatar = ( !empty($HTTP_POST_VARS['user_allowavatar']) ) ? intval( $HTTP_POST_VARS['user_allowavatar'] ) : 0;</find>
        <action type="after-add">
		$user_invites = ( !empty($HTTP_POST_VARS['user_invites']) ) ? intval( $HTTP_POST_VARS['user_invites'] ) : 0;</action>
      </edit>
      <edit>
	   <comment lang="en-GB">
			Reason: Include the user's invites.	
			Location (about): Line 671
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Einladungen auch aktualisieren.
			Ort (ungefähr): Zeile 671
	    </comment>
        <find>				SET " . $username_sql . $passwd_sql . "user_email = '" . str_replace("\'", "''", $email) .  </find>
        <inline-edit>
          <inline-find>$avatar_sql . "</inline-find>
          <inline-action type="after-add">, user_invites = $user_invites</inline-action>
        </inline-edit>
      </edit>
      <edit>
	   <comment lang="en-GB">
			Reason: Infrastructure for the template.
			Location (about): Line 1118
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Zur Erweiterung des Templates
			Ort (ungefähr): Zeile 1118
	    </comment>
        <find><![CDATA[			'L_SELECT_RANK' => $lang['Rank_title'],]]></find>
        <action type="after-add"><![CDATA[
			'L_INVITES' => $lang['Invites'],
			'INVITES' => $this_userdata['user_invites'],]]></action>
      </edit>
    </open>
    <open src="templates/subSilver/admin/user_edit_body.tpl">
      <edit>
	   <comment lang="en-GB">
			Reason: Extend the template	 
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Das Feld für die Einladungen im Template.		 
	    </comment>
        <find><![CDATA[	<td class="row2"><select name="user_rank">{RANK_SELECT_BOX}</select></td>
	</tr>]]></find>
        <action type="after-add"><![CDATA[
	<tr> 
	  <td class="row1"><span class="gen">{L_INVITES}</span></td>
	  <td class="row2"> 
		<input class="post" type="text" name="user_invites" size="5" maxlength="5" value="{INVITES}" />
	  </td>
	</tr>]]></action>
      </edit>
    </open>
    <open src="admin/admin_groups.php">
      <edit>
	   <comment lang="en-GB">
			Reason: Add the template vars for the field to set the groups's invites.	
			Location (about): Line 158
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Templatevariablen für die Gruppeneinladungen.
			Ort (ungefähr): Zeile 158
	    </comment>
        <find><![CDATA[		'U_SEARCH_USER' => append_sid("../search.$phpEx?mode=searchuser"), ]]></find>
        <action type="after-add"><![CDATA[
		'L_INVITES' => $lang['Invites'],
		'INVITES' => $group_info['group_invites'],]]></action>
      </edit>
      <edit>
	   <comment lang="en-GB">
			Reason: Keep the database clean in the case of group deletion.	
			Location (about): Line 241
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Die Datenbank beim Löschen der Gruppe ordentlich halten.
			Ort (ungefähr): Zeile 241
	    </comment>
        <find>			message_die(GENERAL_ERROR, 'Could not update user_group', '', __LINE__, __FILE__, $sql);
		}</find>
        <action type="after-add"><![CDATA[
		//BEGIN Invitation Only U2U MOD
				//We don't actually have to update the invite to reflect the deletion of the group, but I like my database consistent
		$sql = "UPDATE " . INVITATION_TABLE . "
			SET invitation_group= 0
			WHERE (invitation_group = $group_id)";
		if ( !$db->sql_query($sql) )
		{
			message_die(GENERAL_ERROR, 'Could not update invitations', '', __LINE__, __FILE__, $sql);
		}
		//END Invitation Only U2U MOD
]]></action>
      </edit>
      <edit>
	   <comment lang="en-GB">
			Reason: Add the new variale for the group invites.	
			Location (about): Line 261
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Die Variable für die Gruppeneinladungen auslesen.
			Ort (ungefähr): Zeile 261
	    </comment>
        <find>		$delete_old_moderator = isset($HTTP_POST_VARS['delete_old_moderator']) ? true : false;</find>
        <action type="after-add">
		$group_invites = isset($HTTP_POST_VARS['group_invites']) ? intval($HTTP_POST_VARS['group_invites']) : 0;</action>
      </edit>
      <edit>
	   <comment lang="en-GB">
			Reason: Extend the 	SQL query to update the invites as well
			Location (about): Line 330
	    </comment>
	    <comment lang="de-DE"> 
			Funktion: Die SQL Anfrage zur Speicherung der Einladungen erweitern.
			Ort (ungefähr): Zeile 330
	    </comment>
        <find>				SET group_type = $group_type, group_name = '" . str_replace("\'", "''", $group_name) . "', group_description = '" . str_replace("\'", "''", $group_description) . "', group_moderator = $group_moderator </find>
        <inline-edit>
          <inline-find>group_moderator = $group_moderator</inline-find>
          <inline-action type="after-add">, group_invites = $group_invites</inline-action>
        </inline-edit>
      </edit>
      <edit>
	    <comment lang="en-GB">
			Reason: Extend the 	SQL query to update the invites as well
			Location (about): Line 343
	    </comment>
	    <comment lang="de-DE"> 
			Funktion:  Die SQL Anfrage zur Speicherung der Einladungen erweitern.
			Ort (ungefähr): Zeile 343
	    </comment>
        <find>			$sql = "INSERT INTO " . GROUPS_TABLE . " (group_type, group_name, group_description, group_moderator, group_single_user) </find>
        <inline-edit>
          <inline-find>group_single_user</inline-find>
          <inline-action type="after-add">, group_invites</inline-action>
        </inline-edit>
      </edit>
      <edit>
	  <comment lang="en-GB">
			Reason: Extend the 	SQL query to update the invites as well
			Location (about): Line 344
	    </comment>
	    <comment lang="de-DE"> 
			Funktion:  Die SQL Anfrage zur Speicherung der Einladungen erweitern.
			Ort (ungefähr): Zeile 344
	    </comment>
        <find>				VALUES ($group_type, '" . str_replace("\'", "''", $group_name) . "', '" . str_replace("\'", "''", $group_description) . "', $group_moderator,	'0')";</find>
        <inline-edit>
          <inline-find>'0'</inline-find>
          <inline-action type="after-add">, $group_invites</inline-action>
        </inline-edit>
      </edit>
    </open>
    <open src="templates/subSilver/admin/group_edit_body.tpl">
      <edit>
	  <comment lang="en-GB">
			Reason: Extend the group form to show the invite field
		 
	    </comment>
	    <comment lang="de-DE"> 
			Funktion:  Die Gruppenseiteum die Einladungen erweitern.
	 
	    </comment>
        <find><![CDATA[	<input type="radio" name="group_type" value="{S_GROUP_OPEN_TYPE}" {S_GROUP_OPEN_CHECKED} /> {L_GROUP_OPEN} &nbsp;&nbsp;<input type="radio" name="group_type" value="{S_GROUP_CLOSED_TYPE}" {S_GROUP_CLOSED_CHECKED} />	{L_GROUP_CLOSED} &nbsp;&nbsp;<input type="radio" name="group_type" value="{S_GROUP_HIDDEN_TYPE}" {S_GROUP_HIDDEN_CHECKED} />	{L_GROUP_HIDDEN}</td> 
	</tr>]]></find>
        <action type="after-add"><![CDATA[
	<tr> 
	  <td class="row1"><span class="gen">{L_INVITES}:</span></td>
	  <td class="row2"> 
		<input class="post" type="text" name="group_invites" size="5" maxlength="5" value="{INVITES}" />
	  </td>
	</tr>]]></action>
      </edit>
    </open>
    <open src="includes/functions.php">
      <edit>
	    <comment lang="en-GB">
			Reason: Use the new language file.
			Location (about): Line 338
	    </comment>
	    <comment lang="de-DE"> 
			Funktion:  Die neue Sprachdatei einbinden.
			Ort (ungefähr): Zeile 338
	    </comment>
        <find>	include($phpbb_root_path . 'language/lang_' . $board_config['default_lang'] . '/lang_main.' . $phpEx);</find>
        <action type="after-add">
	if ( file_exists(@phpbb_realpath($phpbb_root_path . 'language/lang_' . $board_config['default_lang'] . '/lang_invites.'.$phpEx)) )
	{
		include($phpbb_root_path . 'language/lang_' . $board_config['default_lang'] . '/lang_invites.' . $phpEx);
	}
	else
	{
		include($phpbb_root_path . 'language/lang_english/lang_invites.' . $phpEx);
	}</action>
      </edit>
      <edit>
	  	    <comment lang="en-GB">
			Reason: Use the new language file.
			Location (about): Line 347
	    </comment>
	    <comment lang="de-DE"> 
			Funktion:  Die neue Sprachdatei einbinden.
			Ort (ungefähr): Zeile 347
	    </comment>
        <find>		include($phpbb_root_path . 'language/lang_' . $board_config['default_lang'] . '/lang_admin.' . $phpEx);</find>
        <action type="after-add">
		if( file_exists(@phpbb_realpath($phpbb_root_path . 'language/lang_' . $board_config['default_lang'] . '/lang_invites_admin.'.$phpEx)) )
		{
			include($phpbb_root_path . 'language/lang_' . $board_config['default_lang'] . '/lang_invites_admin.' . $phpEx);
		}
		else
		{
			include($phpbb_root_path . 'language/lang_english/lang_invites_admin.' . $phpEx);
		}</action>
      </edit>
    </open>
    <open src="groupcp.php">
      <edit>
		<comment lang="en-GB">
			Reason: Add the invite link to the groupcp.
			Location (about): Line 1139
	    </comment>
	    <comment lang="de-DE"> 
			Funktion:  Den Einladungslink in das Gruppenkontrollzentrum einbinden.
			Ort (ungefähr): Zeile 1139	    </comment>
        <find><![CDATA[		$template->assign_block_vars('switch_add_member', array());]]></find>
        <action type="after-add"><![CDATA[
		//BEGIN Invitation Only U2U MOD
		if ($board_config['invite_u2u']==2 || (!empty($group_info['group_invites']) &&$board_config['invite_u2u']==1 ))
		{
			if (empty($group_info['group_invites']))
			{
				$invites_text = $lang['No_invites'];	   
			} 
			elseif ($group_info['group_invites'] == 1)
			{
				$invites_text = $lang['One_invite_left'];	   
			}
			else
			{
				$invites_text = $group_info['group_invites'] .' '.$lang['Invites_left'];	  
			}    
		   
			$template->assign_block_vars('switch_invite_option', array());
			$template->assign_vars(array(
				'L_SEND_INVITE' => $lang['Send_invite'],
				'L_SEND_INVITE_EXPLAIN' => $lang['Group_send_invite_explain'],
				'INVITE_LINK' => append_sid("invite.$phpEx?".POST_GROUPS_URL."=$group_id&mode=group",true),
				'INVITES_LEFT' => $invites_text 
			));
			
		}
		//END Invitation Only U2U MOD]]></action>
      </edit>
    </open>
    <open src="templates/subSilver/groupcp_info_body.tpl">
      <edit>
		<comment lang="en-GB">
			Reason: Use the invite link in the template.
	    </comment>
	    <comment lang="de-DE"> 
			Funktion:  Den Einladungslink im Template verwenden.
	    </comment>
        <find><![CDATA[</table>

{S_HIDDEN_FIELDS}]]></find>
        <action type="before-add"><![CDATA[
	<!-- BEGIN switch_invite_option -->
	<tr> 
		<td class="row1" width="20%"><span class="gen">{L_SEND_INVITE}:</span><br /><span class="gensmall">{L_SEND_INVITE_EXPLAIN}</span></td>
		<td class="row2"><span class="gen"><a href="{INVITE_LINK}">{INVITES_LEFT}</a></span></td>
	</tr>
	<!-- END switch_invite_option -->
	]]></action>
      </edit>
    </open>
    <diy-instructions lang="en-GB">
		The default messages can be edited in the $lang files.
		In lang_invites.php:
		$lang['Invitation_sent_body'] and $lang['Invitation_accepted_body'] contain the automated PMs, 
		$lang['Invitation_only_message'] the message displayed on the "Invitation Only" Info page shown to users trying to register.
		In lang_invites_admin:
		$lang['Invitation_only_message'] contains the default invite-email text.
	</diy-instructions>
	<diy-instructions lang="de-DE">
		Die vorgegebenen Benachrichtigungen können in den Sprachdateioen angepasst werden.
		In lang_invites.php:
		$lang['Invitation_sent_body'] und $lang['Invitation_accepted_body'] dienen für die generierten PMs, 
		$lang['Invitation_only_message'] ist der Text der neuen Seite vor der Registrierung.
		In lang_invites_admin:
		$lang['Invitation_only_message'] Den vorgeschlagenen Text für Einladungsmails.
	</diy-instructions>
  </action-group>
</mod>