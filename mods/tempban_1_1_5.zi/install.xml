<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.subsilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.0.xsd">
  <header>
    <license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
    <title lang="en-gb">Temp Ban</title>
    <description lang="en-gb">This MOD adds the option of temporary user, ip, and email bans.</description>
    <author-notes lang="en-gb">
When banning a user, ip, or email from the admin pages, you should
see an extra field for automatically removing the ban after a
number of minutes, hours, days or weeks. Bans that have expired
will be automatically removed from the ban table with no further
admin action required.

Setting the ban-remove field to zero results in a permanent ban.
The default database value for this field is zero. Therefore other
mods that touch the ban table but don't know about this mod will
still cause permanent bans as expected. Also all pre-existing bans
will still be permanent after this mod is installed.

You are free to borrow some or all of the code found in this
package as long as your product includes an attribution to me,
squirrel (Andy McConnell).


---------- { eviL3 } ----------

Credit for this MOD goes to szquirrel. He made it. I will continue
development and provide support for this MOD. And i will update it as well.
</author-notes>
    <author-group>
      <author>
        <realname>Andy McConnell</realname>
        <email>squirrel@digitalsquirrel.com</email>
        <username>szquirrel</username>
        <homepage>http://www.digitalsquirrel.com</homepage>
        <contributions />
      </author>
      <author>
        <realname>Igor Wiedler</realname>
        <email>evil@phpbbmodders.net</email>
        <username>eviL3</username>
        <homepage>http://phpbbmodders.net</homepage>
        <contributions />
      </author>
    </author-group>
    <mod-version>
      <major>1</major>
      <minor>1</minor>
      <revision>5</revision>
    </mod-version>
    <installation>
      <level>intermediate</level>
      <time>900</time>
      <target-version>
        <target-primary>2.0</target-primary>
        <target-major allow="exact">2</target-major>
        <target-minor allow="exact">0</target-minor>
      </target-version>
    </installation>
    <history>
      <entry>
        <date>2006-03-07</date>
        <rev-version>
          <major>0</major>
          <minor>9</minor>
          <revision>0</revision>
        </rev-version>
        <changelog lang="en-gb">
          <change>initial version, w00t!</change>
        </changelog>
      </entry>
      <entry>
        <date>2006-03-08</date>
        <rev-version>
          <major>0</major>
          <minor>9</minor>
          <revision>1</revision>
        </rev-version>
        <changelog lang="en-gb">
          <change>fixed bugs that broke IP and email bans</change>
          <change>added ban expiration dates to the unban list</change>
          <change>changed ban expiration wording to make it clearer</change>
          <change>various tweaks to PHP and MOD syntax</change>
        </changelog>
      </entry>
      <entry>
        <date>2006-03-09</date>
        <rev-version>
          <major>1</major>
          <minor>0</minor>
          <revision>0</revision>
        </rev-version>
        <changelog lang="en-gb">
          <change>fixed bugs in the MOD template (doh!)</change>
          <change>submitted to the MOD database</change>
        </changelog>
      </entry>
      <entry>
        <date>2006-03-16</date>
        <rev-version>
          <major>1</major>
          <minor>0</minor>
          <revision>1</revision>
        </rev-version>
        <changelog lang="en-gb">
          <change>fixed a bug that prevented EasyMod installation</change>
          <change>This is expected to be the last version of TempBan</change>
        </changelog>
      </entry>
      <entry>
        <date>2006-08-17</date>
        <rev-version>
          <major>1</major>
          <minor>1</minor>
          <revision>0</revision>
        </rev-version>
        <changelog lang="en-gb">
          <change>MOD overtaken by eviL3</change>
          <change>Changed the format a little</change>
        </changelog>
      </entry>
      <entry>
        <date>2006-08-17</date>
        <rev-version>
          <major>1</major>
          <minor>1</minor>
          <revision>1</revision>
        </rev-version>
        <changelog lang="en-gb">
          <change>Fixed a little EasyMod problem</change>
        </changelog>
      </entry>
      <entry>
        <date>2006-09-20</date>
        <rev-version>
          <major>1</major>
          <minor>1</minor>
          <revision>2</revision>
        </rev-version>
        <changelog lang="en-gb">
          <change>Changed the timezones to user timezones</change>
          <change>Banned time will be displayed to the user</change>
        </changelog>
      </entry>
      <entry>
        <date>2006-09-28</date>
        <rev-version>
          <major>1</major>
          <minor>1</minor>
          <revision>2</revision>
          <release>a</release>
        </rev-version>
        <changelog lang="en-gb">
          <change>Fixed a lang problem in sessions.php</change>
          <change>Thanks to Lord de Brand</change>
        </changelog>
      </entry>
      <entry>
        <date>2006-10-31</date>
        <rev-version>
          <major>1</major>
          <minor>1</minor>
          <revision>3</revision>
        </rev-version>
        <changelog lang="en-gb">
          <change>Fixed pickyness :P</change>
          <change>It's halloween</change>
          <change>Sorted files alpabetically (self pickyness ftw)</change>
        </changelog>
      </entry>
      <entry>
        <date>2006-11-15</date>
        <rev-version>
          <major>1</major>
          <minor>1</minor>
          <revision>4</revision>
        </rev-version>
        <changelog lang="en-gb">
          <change>Cleaned up / tabbed / commented correctly</change>
          <change>Added swedish translation by DannieSWE</change>
        </changelog>
      </entry>
      <entry>
        <date>2007-01-25</date>
        <rev-version>
          <major>1</major>
          <minor>1</minor>
          <revision>5</revision>
        </rev-version>
        <changelog lang="en-gb">
          <change>Fixed a bug in the ban_reasons_compatibility file</change>
          <change>MODx</change>
		  <change>Fixed a problem with the code of sessions.php</change>
        </changelog>
      </entry>
    </history>
    <meta name="generator" content="Phpbb.ModTeam.Tools (c#)" />
  </header>
  <action-group>
    <sql>
ALTER TABLE phpbb_banlist ADD ban_until INT(11) DEFAULT '0' NOT NULL;
</sql>
    <open src="admin/admin_user_ban.php">
      <edit>
        <find>		$user_list[] = $this_userdata['user_id'];</find>
        <action type="after-add"><![CDATA[
//-- mod : Temp Ban ------------------------------------------------------------
//-- add
		$user_ban_until = 0;
		if ( isset($HTTP_POST_VARS['user_ban_length']) && isset($HTTP_POST_VARS['user_ban_unit']) )
		{
			$user_ban_until = (int) $HTTP_POST_VARS['user_ban_length'] * $HTTP_POST_VARS['user_ban_unit'];
			$user_ban_until = ($user_ban_until > 0) ? (time() + $user_ban_until) : 0;
		}
//-- fin mod : Temp Ban --------------------------------------------------------
]]></action>
      </edit>
      <edit>
        <find>				$ip_list[] = encode_ip(str_replace('*', '255', trim($ip_list_temp[$i])));
			}
		}</find>
        <action type="after-add"><![CDATA[
//-- mod : Temp Ban ------------------------------------------------------------
//-- add
		$ip_ban_until = 0;
		if ( isset($HTTP_POST_VARS['ip_ban_length']) && isset($HTTP_POST_VARS['ip_ban_unit']) )
		{
			$ip_ban_until = (int) $HTTP_POST_VARS['ip_ban_length'] * $HTTP_POST_VARS['ip_ban_unit'];
			$ip_ban_until = ($ip_ban_until > 0) ? (time() + $ip_ban_until) : 0;
		}
//-- fin mod : Temp Ban --------------------------------------------------------
]]></action>
      </edit>
      <edit>
        <find>				$email_list[] = trim($email_list_temp[$i]);
			}
		}</find>
        <action type="after-add"><![CDATA[
//-- mod : Temp Ban ------------------------------------------------------------
//-- add
		$email_ban_until = 0;
		if ( isset($HTTP_POST_VARS['email_ban_length']) && isset($HTTP_POST_VARS['email_ban_unit']) )
		{
			$email_ban_until = (int) $HTTP_POST_VARS['email_ban_length'] * $HTTP_POST_VARS['email_ban_unit'];
			$email_ban_until = ($email_ban_until > 0) ? (time() + $email_ban_until) : 0;
		}
//-- fin mod : Temp Ban --------------------------------------------------------
]]></action>
      </edit>
      <edit>
        <find>			$sql = "INSERT INTO " . BANLIST_TABLE . " (ban_userid</find>
        <inline-edit>
          <inline-find>ban_userid</inline-find>
          <inline-action type="after-add">, ban_until</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find>				VALUES (" . $user_list[$i]</find>
        <inline-edit>
          <inline-find>$user_list[$i]</inline-find>
          <inline-action type="after-add"> . ", " . $user_ban_until</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find>			$sql = "INSERT INTO " . BANLIST_TABLE . " (ban_ip</find>
        <inline-edit>
          <inline-find>ban_ip</inline-find>
          <inline-action type="after-add">, ban_until</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find>				VALUES ('" . $ip_list[$i]</find>
        <inline-edit>
          <inline-find>$ip_list[$i] . "'</inline-find>
          <inline-action type="after-add">, " . $ip_ban_until . "</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find>			$sql = "INSERT INTO " . BANLIST_TABLE . " (ban_email</find>
        <inline-edit>
          <inline-find>ban_email</inline-find>
          <inline-action type="after-add">, ban_until</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find>				VALUES ('" . str_replace("\'", "''", $email_list[$i]</find>
        <inline-edit>
          <inline-find>$email_list[$i]) . "'</inline-find>
          <inline-action type="after-add">, " . $email_ban_until . "</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find>	$sql = "SELECT b.ban_id, u.user_id, u.username</find>
        <action type="before-add">//-- mod : Temp Ban ------------------------------------------------------------
//-- add
	prune_banlist();
//-- fin mod : Temp Ban --------------------------------------------------------
</action>
        <inline-edit>
          <inline-find>b.ban_id</inline-find>
          <inline-action type="after-add">, b.ban_until</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find><![CDATA[		$select_userlist .= '<option value="' . $user_list[$i]['ban_id'] . '">' . $user_list[$i]['username'] . '</option>';]]></find>
        <action type="before-add"><![CDATA[//-- mod : Temp Ban ------------------------------------------------------------
//-- add
		$ban_until = ( $user_list[$i]['ban_until'] > 0 ) ? ' [' . $lang['Expires'] . ' ' . create_date($lang['Expires_format'], $user_list[$i]['ban_until'], $userdata['user_timezone']) . ']' : '';
//-- fin mod : Temp Ban --------------------------------------------------------]]></action>
        <inline-edit>
          <inline-find>['username']</inline-find>
          <inline-action type="after-add"> . $ban_until</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find>	$sql = "SELECT ban_id, ban_ip, ban_email</find>
        <inline-edit>
          <inline-find>ban_email</inline-find>
          <inline-action type="after-add">, ban_until</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find><![CDATA[	for($i = 0; $i < count($banlist); $i++)
	{
		$ban_id = $banlist[$i]['ban_id'];]]></find>
        <action type="after-add"><![CDATA[//-- mod : Temp Ban ------------------------------------------------------------
//-- add
		$ban_until = ( $banlist[$i]['ban_until'] > 0 ) ? ' [' . $lang['Expires'] . ' ' . create_date($lang['Expires_format'], $banlist[$i]['ban_until'], $userdata['user_timezone']) . ']' : '';
//-- fin mod : Temp Ban --------------------------------------------------------]]></action>
      </edit>
      <edit>
        <find><![CDATA[			$select_iplist .= '<option value="' . $ban_id . '">' . $ban_ip . '</option>';]]></find>
        <inline-edit>
          <inline-find>$ban_ip</inline-find>
          <inline-action type="after-add"> . $ban_until</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find><![CDATA[			$select_emaillist .= '<option value="' . $ban_id . '">' . $ban_email . '</option>';]]></find>
        <inline-edit>
          <inline-find>$ban_email</inline-find>
          <inline-action type="after-add"> . $ban_until</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find><![CDATA[		'L_FIND_USERNAME' => $lang['Find_username'],]]></find>
        <action type="after-add"><![CDATA[
//-- mod : Temp Ban ------------------------------------------------------------
//-- add
		'L_MINUTES'	=> $lang['Minutes'],
		'L_HOURS'	=> $lang['Hours'],
		'L_DAYS'	=> $lang['Days'],
		'L_WEEKS'	=> $lang['Weeks'],
		'L_EXPIRES_AFTER'	=> $lang['Expires_after'],
		'L_EXPIRES_EXPLAIN'	=> $lang['Expires_explain'],
//-- fin mod : Temp Ban --------------------------------------------------------
]]></action>
      </edit>
    </open>
    <open src="includes/functions.php">
      <edit>
        <find>	include($phpbb_root_path . 'language/lang_' . $board_config['default_lang'] . '/lang_main.' . $phpEx);</find>
        <inline-edit>
          <inline-find>include</inline-find>
          <inline-action type="replace-with">include_once</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find><![CDATA[?>]]></find>
        <action type="before-add"><![CDATA[
//-- mod : Temp Ban ------------------------------------------------------------
//-- add
function prune_banlist()
{
	global $db;

	$sql = "DELETE FROM " . BANLIST_TABLE .
		" WHERE ban_until <> 0 AND ban_until < " . time();
	if (!($result = $db->sql_query($sql)))
	{
		message_die(GENERAL_ERROR, 'Could not access banlist', '', __LINE__, __FILE__, $sql);
	}
}
//-- fin mod : Temp Ban --------------------------------------------------------
]]></action>
      </edit>
    </open>
    <open src="includes/functions_post.php">
      <edit>
        <find>			$sql = "SELECT ban_userid </find>
        <action type="before-add">
//-- mod : Temp Ban ------------------------------------------------------------
//-- add
			prune_banlist();
//-- fin mod : Temp Ban --------------------------------------------------------
</action>
      </edit>
    </open>
    <open src="includes/functions_validate.php">
      <edit>
        <find>			$sql = "SELECT ban_email</find>
        <action type="before-add">
//-- mod : Temp Ban ------------------------------------------------------------
//-- add
			prune_banlist();
//-- fin mod : Temp Ban --------------------------------------------------------
</action>
      </edit>
    </open>
    <open src="includes/sessions.php">
      <edit>
        <find>	global $HTTP_COOKIE_VARS,</find>
        <action type="after-add"><![CDATA[//-- mod : Temp Ban ------------------------------------------------------------
//-- add
	global $lang, $phpbb_root_path, $phpEx;
	
	$default_lang = str_replace('lang_', '', $board_config['default_lang']);
	
	if ( !file_exists(@phpbb_realpath("{$phpbb_root_path}language/lang_{$default_lang}/lang_main.{$phpEx}")) )
	{
		message_die(CRITICAL_ERROR, 'Could not locate valid language pack');
	}
	
	include_once("{$phpbb_root_path}language/lang_{$default_lang}/lang_main.{$phpEx}");
//-- fin mod : Temp Ban --------------------------------------------------------
]]></action>
      </edit>
      <edit>
        <find>	$sql = "SELECT ban_ip, ban_userid, ban_email </find>
        <action type="before-add">
//-- mod : Temp Ban ------------------------------------------------------------
//-- add
	prune_banlist();
//-- fin mod : Temp Ban --------------------------------------------------------
</action>
        <inline-edit>
          <inline-find>, ban_email</inline-find>
          <inline-action type="after-add">, ban_until</inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find>if ( $ban_info = $db->sql_fetchrow($result) )
	{
</find>
        <action type="after-add"><![CDATA[
//-- mod : Temp Ban ------------------------------------------------------------
//-- add
		$ban_until = create_date( $lang['Expires_format_banned'], $ban_info['ban_until'], $board_config['board_timezone'] );
		if ( $ban_info['ban_until'] > 0 )
		{
			message_die(CRITICAL_MESSAGE, $lang['You_been_banned'] . '<br /><br />' . $lang['Expires_msg_banned'] . $ban_until);
		}
//-- fin mod : Temp Ban --------------------------------------------------------
]]></action>
      </edit>
    </open>
    <open src="language/lang_english/lang_admin.php">
      <edit>
        <find><![CDATA[?>]]></find>
        <action type="before-add">
//-- mod : Temp Ban ------------------------------------------------------------
//-- add
$lang['Expires_after']		= 'Ban expires after';
$lang['Expires_explain']	= 'Set to zero for a permanent ban';
$lang['Expires']		= 'Expires';
$lang['Expires_format']	= 'd M Y g:i a';
//-- fin mod : Temp Ban --------------------------------------------------------
</action>
      </edit>
    </open>
    <open src="language/lang_english/lang_main.php">
      <edit>
        <find><![CDATA[?>]]></find>
        <action type="before-add">
//-- mod : Temp Ban ------------------------------------------------------------
//-- add
// 'Hours' and 'Days' are defined elsewhere
$lang['Seconds']	= 'Seconds';
$lang['Minutes']	= 'Minutes';
$lang['Weeks']	= 'Weeks';

// Added in version 1.1.2 to display the banned time to banned members
$lang['Expires_msg_banned']		= 'Your ban expires on ';
$lang['Expires_format_banned']	= 'd M Y g:i a';
//-- fin mod : Temp Ban --------------------------------------------------------
</action>
      </edit>
    </open>
    <open src="templates/subSilver/admin/user_ban_body.tpl">
      <edit>
        <find><![CDATA[<p>{L_BAN_EXPLAIN}</p>]]></find>
        <action type="after-add"><![CDATA[
<p><b>{S_CURRENT_TIME}</b></p>
]]></action>
      </edit>
      <edit>
        <find><![CDATA[	  <td class="row2"><input class="post" type="text" class="post" name="username" maxlength="50" size="20" />]]></find>
        <inline-edit>
          <inline-find><![CDATA[</td>]]></inline-find>
          <inline-action type="before-add"><![CDATA[ <br />{L_EXPIRES_AFTER} <input class="post" type="text" name="user_ban_length" value="0" size="4" /> <select name="user_ban_unit"><option selected="selected" value="60">{L_MINUTES}</option><option value="3600">{L_HOURS}</option><option value="86400">{L_DAYS}</option><option value="604800">{L_WEEKS}</option></select> <br /><span class="gensmall">{L_EXPIRES_EXPLAIN}</span>]]></inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find><![CDATA[	  <td class="row2"><input class="post" type="text" name="ban_ip" size="35" /></td>]]></find>
        <inline-edit>
          <inline-find><![CDATA[</td>]]></inline-find>
          <inline-action type="before-add"><![CDATA[ <br />{L_EXPIRES_AFTER} <input class="post" type="text" name="ip_ban_length" value="0" size="4" /> <select name="ip_ban_unit"><option selected="selected" value="60">{L_MINUTES}</option><option value="3600">{L_HOURS}</option><option value="86400">{L_DAYS}</option><option value="604800">{L_WEEKS}</option></select> <br /><span class="gensmall">{L_EXPIRES_EXPLAIN}</span>]]></inline-action>
        </inline-edit>
      </edit>
      <edit>
        <find><![CDATA[	  <td class="row2"><input class="post" type="text" name="ban_email" size="35" /></td>]]></find>
        <inline-edit>
          <inline-find><![CDATA[</td>]]></inline-find>
          <inline-action type="before-add"><![CDATA[ <br />{L_EXPIRES_AFTER} <input class="post" type="text" name="email_ban_length" value="0" size="4" /> <select name="email_ban_unit"><option selected="selected" value="60">{L_MINUTES}</option><option value="3600">{L_HOURS}</option><option value="86400">{L_DAYS}</option><option value="604800">{L_WEEKS}</option></select> <br /><span class="gensmall">{L_EXPIRES_EXPLAIN}</span>]]></inline-action>
        </inline-edit>
      </edit>
    </open>
  </action-group>
</mod>