<body onunload=exit()><form method="POST">  <p align="center"><i><font size="3">Difference Analysis Generated by   <a href="http://www.ComponentSoftware.com/products/htmldiff" target="_blank">HtmlDiff</a> on  03/07/2007 19:10</font></i>&nbsp;&nbsp;
  <input type="button" value="Navigate Changes" name="Navigate" onclick=pop_navigate()></p></form></body> <p align="left"><font size="4"><b>Base file: C:\Documents and Settings\Ma®©uS\Desktop\v8\Contact Form\root\admin\admin_contact_log.php</b></font></p> <p align="left"><font size="4"><b>Modified file: C:\Documents and Settings\Ma®©uS\Desktop\v9\Contact Form\root\admin\admin_contact_log.php</b></font></p><html>
<style type="text/css">
<!--
.HDNormal {  color: #000000;background:  #ffffff;text-decoration:none}
.HDDeleted {  color: #ff0000;background:  #ffffff;text-decoration:line-through}
.HDAdded {  color: #000000;background:  #ffff00;text-decoration:none}
-->
</style>
<body>
<pre>
 <span class="HDNormal">
&lt;?php
/***************************************************************************
 *                               admin_contact_log.php
 *                               ---------------------
 *  Version:    <a name="diff" id="c0"><span class="HDDeleted">8.9.7</span></a><span class="HDAdded">9.0.0</span>
 *  Begin:      Sunday, Sept 17, 2006
 *      Copyright:  (C) 2006<a name="diff" id="c1"><span class="HDAdded">-07</span></a>, Marcus
 *  E-mail:     marcus@phobbia.net
 *  $id:        <a name="diff" id="c2"><span class="HDDeleted">23:43 14/05</span></a><span class="HDAdded">17:46 03/07</span>/2007
 *
 ***************************************************************************/

/***************************************************************************
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation; either version 2 of the License, or
 *   (at your option) any later version.
 *
 ***************************************************************************/

define('IN_PHPBB', 1);

if( !empty($setmodules) )
{
    $filename = basename(__FILE__);
    $module['General']['Contact<a name="diff" id="c3"><span class="HDDeleted"> </span></a><span class="HDAdded">_</span>Messages'] = $filename;
    return;
}

$phpbb_root_path = './../';
include($phpbb_root_path.'extension.inc');
include('./pagestart.'.$phpEx);
include($phpbb_root_path . 'language/lang_' . $board_config['default_lang'] . '/lang_contact.'.$phpEx);

$start = (isset($HTTP_GET_VARS['start']) || isset($HTTP_POST_VARS['start'])) ? intval($HTTP_GET_VARS['start']) : 0; 
$pagination = ''; 
$total_pag_items = 1; 

$confirm = (isset($HTTP_POST_VARS['confirm'])) ? true : false;
$delete = (isset($HTTP_POST_VARS['delete'])) ? true : false;

if(isset($HTTP_POST_VARS['mode']) || isset($HTTP_GET_VARS['mode']))
{
    $mode = (isset($HTTP_POST_VARS['mode'])) ? $HTTP_POST_VARS['mode'] : $HTTP_GET_VARS['mode'];
    $mode = htmlspecialchars($mode);
}
else
{
    if($delete)
    {
        $mode = 'delete';
    }
    else
    {
        $mode = '';
    }
}

if(isset($HTTP_POST_VARS['cancel']))
{
    $mode = '';
}

if($mode == 'delete')
{
    if($cancel)
    {
        $redirect = 'admin/admin_contact_log.'.$phpEx;
        redirect(append_sid($redirect, true));
    }

    if(!$confirm)
    {
        $msg_ids = $HTTP_POST_VARS['msgid'];

        if(empty($HTTP_POST_VARS['msgid']))
        {
            $redirect = 'admin/admin_contact_log.'.$phpEx;
            redirect(append_sid($redirect, true));
        }

        $hidden_fields = '';
        for($i = 0<a name="diff" id="c4"><span class="HDDeleted">; $i &lt;</span></a><span class="HDAdded">, $msgs =</span> count($msg_ids)<span class="HDAdded">; $i &lt; $msgs</span>; $i++)
        {
            $hidden_fields .= '&lt;input type="hidden" name="msgid[]" value="' . intval($msg_ids[$i]) . '" /&gt;';
        }

        $template-&gt;set_filenames(array(
            'body' =&gt; 'admin/confirm_body.tpl')
        );

        $template-&gt;assign_vars(array(
            'MESSAGE_TITLE' =&gt; $lang['Confirm'],
            'MESSAGE_TEXT' =&gt; $lang['Confirm_delete_msg'],

            'L_YES' =&gt; $lang['Yes'],
            'L_NO' =&gt; $lang['No'],

            'S_CONFIRM_ACTION' =&gt; append_sid('admin_contact_log.'.$phpEx.'?mode=delete'),
            'S_HIDDEN_FIELDS' =&gt; $hidden_fields)
        );

        $template-&gt;pparse('body');
    }
    else
    {
        $msg_ids = (isset($HTTP_POST_VARS['msgid'])) ? $HTTP_POST_VARS['msgid'] : array($msgid);

        $del_msg_sql = '';
        for($i = 0<a name="diff" id="c5"><span class="HDDeleted">; $i &lt;</span></a><span class="HDAdded">, $msgs =</span> count($msg_ids)<span class="HDAdded">; $i &lt; $msgs</span>; $i++)
        {
            $del_msg_sql .= (($del_msg_sql != '') ? ', ' : '') . intval($msg_ids[$i]);
        }

        $sql = "DELETE FROM " . CONTACT_MSGS_TABLE . "
            WHERE msg_id IN ($del_msg_sql)";
<a name="diff" id="c6"><span class="HDAdded">
</span></a>        if(!<span class="HDDeleted">(</span>$result = $db-&gt;sql_query($sql<span class="HDDeleted">)</span>))
        {
            message_die(GENERAL_ERROR, 'Could not delete message(s)', '', __LINE__, __FILE__, $sql);
        }

        if($del_msg_sql == '')
        {
            $redirect = 'admin/admin_contact_log.'.$phpEx;
            redirect(append_sid($redirect, true));
        }

        $message = $lang['Msg_del_success'] . "&lt;br /&gt;&lt;br /&gt;" . sprintf($lang['Click_return_msglog'], "&lt;a href=\"" . append_sid("admin_contact_log.$phpEx") . "\"&gt;", "&lt;/a&gt;") . "&lt;br /&gt;&lt;br /&gt;" . sprintf($lang['Click_return_admin_index'], "&lt;a href=\"" . append_sid("index.$phpEx?pane=right") . "\"&gt;", "&lt;/a&gt;");
        message_die(GENERAL_MESSAGE, $message);
    }
}

if($mode == 'remove')
{
    $contact_config = array();

    $sql = "SELECT *
        FROM " . CONTACT_CONFIG_TABLE;

    if(!<a name="diff" id="c7"><span class="HDDeleted">(</span></a>$result = $db-&gt;sql_query($sql<span class="HDDeleted">)</span>))
    {
        message_die(CRITICAL_ERROR, 'Could not query config information', '', __LINE__, __FILE__, $sql);
    }
    while ($row = $db-&gt;sql_fetchrow($result))
    {
        $contact_config[$row['config_name']] = $row['config_value'];
    }

    $file_id = (!empty($HTTP_POST_VARS['file'])) ? $HTTP_POST_VARS['file'] : $HTTP_GET_VARS['file'];

    $msg_id = (!empty($HTTP_POST_VARS['id'])) ? $HTTP_POST_VARS['id'] : $HTTP_GET_VARS['id'];
    $msg_id = intval($msg_id);

    $confirm = isset($HTTP_POST_VARS['confirm']);

    if($confirm)
    {
        $filename = $HTTP_POST_VARS['file'];

        if(file_exists($filename))
        {
            @unlink($filename);
            clearstatcache();

            $sql = "UPDATE " . CONTACT_MSGS_TABLE . "
                SET <a name="diff" id="c8"><span class="HDAdded">up</span></a>file = ''
                WHERE msg_id = " . $msg_id;

            if(!<a name="diff" id="c9"><span class="HDDeleted">(</span></a>$result = $db-&gt;sql_query($sql<span class="HDDeleted">)</span>))
            {
                message_die(GENERAL_ERROR, 'Could not update Contact table', '', __LINE__, __FILE__, $sql);
            }

            $message = $lang['File_del_success'] . "&lt;br /&gt;&lt;br /&gt;" . sprintf($lang['Click_return_msglog'], "&lt;a href=\"" . append_sid("admin_contact_log.$phpEx") . "\"&gt;", "&lt;/a&gt;") . "&lt;br /&gt;&lt;br /&gt;" . sprintf($lang['Click_return_admin_index'], "&lt;a href=\"" . append_sid("index.$phpEx?pane=right") . "\"&gt;", "&lt;/a&gt;");
            message_die(GENERAL_MESSAGE, $message);
        }
        else
        {
            clearstatcache();

            $sql = "UPDATE " . CONTACT_MSGS_TABLE . "
                SET <a name="diff" id="c10"><span class="HDAdded">up</span></a>file = ''
                WHERE msg_id = " . $msg_id;

            if(!<a name="diff" id="c11"><span class="HDDeleted">(</span></a>$result = $db-&gt;sql_query($sql<span class="HDDeleted">)</span>))
            {
                message_die(GENERAL_ERROR, 'Could not update Contact table', '', __LINE__, __FILE__, $sql);
            }

            $message = $lang['File_Not_Here'] . "&lt;br /&gt;&lt;br /&gt;" . sprintf($lang['Click_return_msglog'], "&lt;a href=\"" . append_sid("admin_contact_log.$phpEx") . "\"&gt;", "&lt;/a&gt;") . "&lt;br /&gt;&lt;br /&gt;" . sprintf($lang['Click_return_admin_index'], "&lt;a href=\"" . append_sid("index.$phpEx?pane=right") . "\"&gt;", "&lt;/a&gt;");
            message_die(GENERAL_ERROR, $message);
        }
    }
    else
    {
        $template-&gt;set_filenames(array(
            'body' =&gt; 'admin/confirm_body.tpl')
        );

        $hidden_fields = '&lt;input type="hidden" name="mode" value="remove" /&gt;&lt;input type="hidden" name="id" value="' . $msg_id . '" /&gt;&lt;input type="hidden" name="file" value="' . $file_id . '" /&gt;';

        $template-&gt;assign_vars(array(
            'MESSAGE_TITLE' =&gt; $lang['Confirm'],
            'MESSAGE_TEXT'=&gt; $lang['Confirm_delete_file'],

            'L_YES' =&gt; $lang['Yes'],
            'L_NO' =&gt; $lang['No'],

            'S_CONFIRM_ACTION' =&gt; append_sid("admin_contact_log.$phpEx"),
            'S_HIDDEN_FIELDS'=&gt; $hidden_fields)
        );

        $template-&gt;pparse('body');
    }
}

if($mode == 'full')
{
    $msg_id = (!empty($HTTP_POST_VARS['id'])) ? $HTTP_POST_VARS['id'] : $HTTP_GET_VARS['id'];
    $msg_id = intval($msg_id);

    $template-&gt;set_filenames(array(
        'body' =&gt; 'admin/contact_fullmsg.tpl')
    );

    $sql = "SELECT *
        FROM " . CONTACT_MSGS_TABLE . "
        WHERE msg_id = " . $msg_id;

    <a name="diff" id="c12"><span class="HDAdded">if(!</span></a>$result = $db-&gt;sql_query($sql)<span class="HDDeleted">;</span><span class="HDAdded">)</span>
<span class="HDDeleted">    if(!$result)
</span>    {
        message_die(GENERAL_ERROR, 'Could not obtain message from database', '', __LINE__, __FILE__, $sql);
    }

    $message = $db-&gt;sql_fetchrow($result);

    $template-&gt;assign_vars(array(
        'MESSAGE' =&gt; $message['message'] . "&lt;hr /&gt;")
    );

    $template-&gt;pparse('body');
}

if($mode == '')
{
    $sql = "SELECT *
        FROM " . CONTACT_MSGS_TABLE . "
        ORDER BY sendtime DESC
        LIMIT " . $start . ", " . $board_config['topics_per_page'];

    <a name="diff" id="c13"><span class="HDAdded">if(!</span></a>$result = $db-&gt;sql_query($sql)<span class="HDDeleted">;</span><span class="HDAdded">)</span>
<span class="HDDeleted">    if(!$result)
</span>    {
        message_die(GENERAL_ERROR, 'Couldnt obtain messages from database', '', __LINE__, __FILE__, $sql);
    }

    $messages = $db-&gt;sql_fetchrowset($result);

    $template-&gt;set_filenames(array(
        'body' =&gt; 'admin/contact_msgs.tpl')
    );

    $template-&gt;assign_vars(array(
        'L_MSGS_TITLE'  =&gt; $lang['Contact_msgs_title'],
        'L_MSGS_TEXT'   =&gt; $lang['Contact_msgs_text'],

        'L_DATE'    =&gt; $lang['Contact_date'],
        'L_USER'    =&gt; $lang['Username'],
        'L_NAME'    =&gt; $lang['Real_name'],
        'L_EMAIL'   =&gt; $lang['E-mail'],
        'L_MESSAGE' =&gt; $lang['Comments'],
        'L_IP'      =&gt; $lang['Contact_ip'],
        'L_FILE'    =&gt; $lang['Attachment'],
        'L_MSG_DELETE'  =&gt; $lang['Msg_delete'],

        'COPYRIGHT' =&gt; $lang['Copyright'],

        'S_HIDDEN_FIELDS'   =&gt; $s_hidden_fields,
        'S_MSG_ACTION'      =&gt; append_sid("admin_contact_log.$phpEx"))
    );

    for($i=0<a name="diff" id="c14"><span class="HDDeleted">; $i &lt;</span></a><span class="HDAdded">, $msg_row =</span> count($messages)<span class="HDAdded">; $i &lt; $msg_row</span>; $i++)
    {
        $row_color = (!($i % 2)) ? $theme['td_color1'] : $theme['td_color2'];
        $row_class = (!($i % 2)) ? $theme['td_class1'] : $theme['td_class2'];

        //
        // Prevent Stretching of the Message Log<a name="diff" id="c15"><span class="HDAdded"> screen</span></a>
        // Based on "50 characters in message" mod by "Underhill"
        //
        if(preg_match("/([^[:blank:]]{30})/", $messages[$i]['message']))
        {
            $message_array = preg_split("/\n/", $messages[$i]['message']);
            for($j=0<a name="diff" id="c16"><span class="HDDeleted">; $j &lt;</span></a><span class="HDAdded">, $msgs =</span> count($message_array)<span class="HDAdded">; $j &lt; $msgs</span>; $j++)
            {
                $message_array[$j] = preg_replace("/([^[:blank:]]{30})/", "\\1 ", $message_array[$j]);
                $messages[$i]['message'] = implode("\n", $message_array);
            }
        }

        $preview = (strlen($messages[$i]['message']) &gt; 100) ? true : false;
<a name="diff" id="c17"><span class="HDAdded">
</span></a>        if($preview)
        {
            $id     = $messages[$i]['msg_id'];
            $full_msg   = "...&amp;nbsp;[&lt;a href=" . append_sid("admin_contact_log.$phpEx?mode=full&amp;amp;id=$id") . " onclick=\"window.open('" . append_sid("admin_contact_log.$phpEx?mode=full&amp;amp;id=$id") . "', 'Message', 'left=100,top=100,height=300,width=300,resizable=yes,scrollbars=yes'); return false;\"&gt;" . $lang['more'] . "&lt;/a&gt;]";
            $preview    = substr($messages[$i]['message'], 0, 100);
            $from       = strlen($lang['more'])+6;
            $preview    = substr_replace($preview, $full_msg, (100-$from), 100);
        }

        $template-&gt;assign_block_vars('messages', array(
            'ROW_COLOR' =&gt; "#" . $row_color,
            'ROW_CLASS' =&gt; $row_class,
            
            'DATE'      =&gt; date("d-m-y", $messages[$i]['sendtime']),
            'TIME'      =&gt; date("H:i", $messages[$i]['sendtime']),
            'MSG_ID'    =&gt; $messages[$i]['msg_id'],
            'USER'      =&gt; $messages[$i]['username'],
            'NAME'      =&gt; $messages[$i]['realname'],
            'EMAIL'     =&gt; $messages[$i]['email'],
            'MESSAGE'   =&gt; ($preview) ? $preview : $messages[$i]['message'],
            'IP'        =&gt; decode_ip($messages[$i]['ip']),
            'FILE'      =&gt; $messages[$i]['<a name="diff" id="c18"><span class="HDAdded">up</span></a>file'],

            'L_DELETE'  =&gt; $lang['Delete'],

            'S_THIS_ID' =&gt; 'msgid',
            'MSG_ID'    =&gt; $messages[$i]['msg_id'],

            'U_GET_FILE'    =&gt; (empty($messages[$i]['<a name="diff" id="c19"><span class="HDAdded">up</span></a>file'])) ? '' : sprintf($lang['Contact_get'], "&lt;a href=\"" . $phpbb_root_path . $messages[$i]['<span class="HDAdded">up</span>file'] . "\"&gt;", "&lt;/a&gt;"),
            'U_REMOVE_FILE' =&gt; (empty($messages[$i]['<span class="HDAdded">up</span>file'])) ? '' : sprintf($lang['Contact_remove'], "&lt;a href=\"" . append_sid("admin_contact_log.$phpEx?mode=remove&amp;amp;id=" . $messages[$i]['msg_id'] . "&amp;amp;file=" . $phpbb_root_path . $messages[$i]['<span class="HDAdded">up</span>file']) . "\"&gt;", "&lt;/a&gt;"),
            'U_MSG_DELETE'  =&gt; append_sid("admin_contact_log.$phpEx?mode=delete"))
        );
    }

    $sql = "SELECT count(*) AS total 
        FROM " . CONTACT_MSGS_TABLE; 
<a name="diff" id="c20"><span class="HDAdded">
</span></a>    if(!<span class="HDDeleted">(</span>$result = $db-&gt;sql_query($sql<span class="HDDeleted">)</span>))
    {
        message_die(GENERAL_ERROR, 'Error getting total', '', __LINE__, __FILE__, $sql);
    }

    if($total = $db-&gt;sql_fetchrow($result))
    {
        if($total['total'] &gt; 0)
        {
            $total_pag_items = $total['total'];
            $pagination = generate_pagination("admin_contact_log.$phpEx?mode=$mode", $total_pag_items, $board_config['topics_per_page'], $start);
        }
    }

    $template-&gt;assign_vars(array(
        'PAGINATION' =&gt; $pagination,
        'PAGE_NUMBER' =&gt; sprintf($lang['Page_of'], (floor($start / $board_config['topics_per_page']) +1), ceil($total_pag_items / $board_config['topics_per_page'])))
    );

    $template-&gt;pparse('body');
}

include('./page_footer_admin.'.$phpEx);

?&gt;</span>
</pre>
</body>
<SCRIPT LANGUAGE="JavaScript" TYPE="text/javascript">
<!--
var newWind;
function putJumpCode(){
	var cnt = 21;
	newWind.document.write('<html>\n');
	newWind.document.write('<title>HtmlDiff Navigation</title>\n');
	newWind.document.write('<body>\n');
	newWind.document.write('<form name="jump">\n');
	newWind.document.write('<input type="button" value=" |&lt; " name="First" onclick=goto_first(this.form)>&nbsp;')
	newWind.document.write('<input type="button" value=" &lt; " name="Prev" onclick=goto_prev(this.form)>&nbsp;&nbsp;\n');
	newWind.document.write('<select name=url onchange=menu_goto(this.form)> \n');
	for (var i=0; i<cnt ;i++ ) {
		newWind.document.write('<option value="#c'+i+'">Change #'+(i+1)+ '</option> \n');
		}
	newWind.document.write('');
	newWind.document.write('</select>&nbsp;&nbsp;\n');
	newWind.document.write('<input type="button" value=" &gt; " name="Next"\n');
	newWind.document.write('onclick=goto_next(this.form)>\n');
	newWind.document.write('<input type="button" value=" &gt| " name="Last"\n');
	newWind.document.write('onclick=goto_last(this.form)>\n');
	newWind.document.write('</form>\n');
	newWind.document.write('');
	newWind.document.write('<form method="POST">\n');
	newWind.document.write('<p align="center"><i><font size="3">Generated\n');
	newWind.document.write('by <a href="http://www.ComponentSoftware.com/products/htmldiff" target="_blank">HtmlDiff</a> \n');
	newWind.document.write('</form>\n');
	newWind.document.write('</body>\n');
	newWind.document.write('</html>\n');
	newWind.document.write('<SCRIPT LANGUAGE="JavaScript" TYPE="text/javascript">\n');
	newWind.document.write('<!--\n');
	newWind.document.write('');
	newWind.document.write('var directCloseFlag=1;\n');
	newWind.document.write('');
	newWind.document.write('function menu_goto( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('  var baseurl = opener.location.href ;\n');
	newWind.document.write('  var idx = baseurl.indexOf("#");\n');
	newWind.document.write('  if (idx > -1) {\n');
	newWind.document.write('	baseurl = baseurl.slice(0, idx);\n');
	newWind.document.write('  }');
	newWind.document.write('  selecteditem = menuform.url.selectedIndex ;\n');
	newWind.document.write('  newurl = menuform.url.options[ selecteditem ].value ;\n');
	newWind.document.write('  if (newurl.length != 0) {\n');
	newWind.document.write('    	opener.top.location.href = baseurl + newurl ;\n');
	newWind.document.write('  }');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function goto_prev( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('	if(menuform.url.selectedIndex>0) menuform.url.selectedIndex--;\n');
	newWind.document.write('	menu_goto( menuform )\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function goto_first( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('	menuform.url.selectedIndex = 0;	\n');
	newWind.document.write('	menu_goto( menuform );\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function goto_last( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('	menuform.url.selectedIndex = menuform.url.options.length-1;	\n');
	newWind.document.write('	menu_goto( menuform );\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function goto_next( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('	if(menuform.url.options.length > (menuform.url.selectedIndex+1))\n');
	newWind.document.write('	menuform.url.selectedIndex++;\n');
	newWind.document.write('	menu_goto( menuform )\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function restore()\n');
	newWind.document.write('{\n');
	newWind.document.write('    	focus();\n');
	newWind.document.write('	menu_goto(jump);\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('goto_first(jump)\n');
	newWind.document.write('//-->\n');
	newWind.document.write('<');
	newWind.document.write('/SCRIPT>\n');
}
function pop_navigate(){
var isOpen = false
try {
isOpen = (newWind != null) && (!newWind.closed)
} catch (e) {}
  if (!isOpen) {
    newWind =  window.open("" ,"HtmlDiffJumpWindow","width=270,height=40")
    if (newWind.opener == null) { // for Nav 2.0x
      newWind.opener = self // this creates and sets a new prop
    }	putJumpCode();
  
} 
else 
{	newWind.execScript("restore()", "JavaScript");
  }
}
function exit(){
var isOpen = false
try {
isOpen = (newWind != null) && (!newWind.closed)
} catch (e) {}
if (isOpen) {
	newWind.close();
  }
}
//--></SCRIPT></html>
