<body onunload=exit()><form method="POST">  <p align="center"><i><font size="3">Difference Analysis Generated by   <a href="http://www.ComponentSoftware.com/products/htmldiff" target="_blank">HtmlDiff</a> on  03/07/2007 19:10</font></i>&nbsp;&nbsp;
  <input type="button" value="Navigate Changes" name="Navigate" onclick=pop_navigate()></p></form></body> <p align="left"><font size="4"><b>Base file: C:\Documents and Settings\Ma®©uS\Desktop\v8\Contact Form\root\contact.php</b></font></p> <p align="left"><font size="4"><b>Modified file: C:\Documents and Settings\Ma®©uS\Desktop\v9\Contact Form\root\contact.php</b></font></p><html>
<style type="text/css">
<!--
.HDNormal {  color: #000000;background:  #ffffff;text-decoration:none}
.HDDeleted {  color: #ff0000;background:  #ffffff;text-decoration:line-through}
.HDAdded {  color: #000000;background:  #ffff00;text-decoration:none}
-->
</style>
<body>
<pre>
 <span class="HDNormal">
&lt;?php
/***************************************************************************
 *                contact.php
 *                -----------
 *  Version:    <a name="diff" id="c0"><span class="HDDeleted">8.9.6</span></a><span class="HDAdded">9.0.0</span>
 *  Begin:      Sunday, Sept 17, 2006
 *      Copyright:  (C) 2006<a name="diff" id="c1"><span class="HDAdded">-07</span></a>, Marcus
 *  E-mail:     marcus@phobbia.net
 *  $id:        <a name="diff" id="c2"><span class="HDDeleted">00:57 11/05</span></a><span class="HDAdded">21:55 25/06</span>/2007
 *
 ***************************************************************************/

/***************************************************************************
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation; either version 2 of the License, or
 *   (at your option) any later version.
 *
 ***************************************************************************/

define('IN_PHPBB', true);

$phpbb_root_path = './';
require($phpbb_root_path . 'extension.inc');
include($phpbb_root_path . 'common.'.$phpEx);
<a name="diff" id="c3"><span class="HDDeleted">include($phpbb_root_path . 'language/lang_' . $board_config['default_lang'] . '/lang_contact.'.$phpEx);
</span></a>
//
// Session management
//
$userdata = session_pagestart($user_ip, PAGE_CONTACT_FORM);
init_userprefs($userdata);

<a name="diff" id="c4"><span class="HDAdded">include($phpbb_root_path . 'language/lang_' . $board_config['default_lang'] . '/lang_contact.'.$phpEx);

</span></a>$contact_config = array();
<a name="diff" id="c5"><span class="HDAdded">$_br = '&lt;br /&gt;&lt;br /&gt;';
</span></a>
$sql = "SELECT *
    FROM " . CONTACT_CONFIG_TABLE;

<a name="diff" id="c6"><span class="HDDeleted">    </span></a>if(!($result = $db-&gt;sql_query($sql)))
<span class="HDDeleted">    </span>{
    <span class="HDDeleted">    </span>message_die(CRITICAL_ERROR, <span class="HDDeleted">"</span><span class="HDAdded">'</span>Could not query config information<span class="HDDeleted">", ""</span><span class="HDAdded">', ''</span>, __LINE__, __FILE__, $sql);
<span class="HDDeleted">    </span>}
<span class="HDDeleted">    </span>while ($row = $db-&gt;sql_fetchrow($result))
<span class="HDDeleted">    </span>{
        $contact_config[$row['config_name']] = $row['config_value'];
<a name="diff" id="c7"><span class="HDDeleted">    </span></a>}

//
// Is the Form Enabled?
//
if($contact_config['contact_form_enable'] == 0)
{
    message_die(GENERAL_MESSAGE, $lang['Contact_Disabled'] . <a name="diff" id="c8"><span class="HDDeleted">"&lt;br /&gt;&lt;br /&gt;"</span></a><span class="HDAdded">$_br</span> . sprintf($lang['Click_return_index'], "&lt;a href=" . append_sid('index.'.$phpEx) . "&gt;", "&lt;/a&gt;"));
}

//
// Assign parameters
//
$user_name      = $userdata['username'];
$real_name      = (!isset($HTTP_POST_VARS['real_name'])) ? '' : stripslashes(trim(htmlspecialchars($HTTP_POST_VARS['real_name'])));
$email          = (!isset($HTTP_POST_VARS['email'])) ? '' : stripslashes(trim(htmlspecialchars($HTTP_POST_VARS['email'])));
$comments       = (!isset($HTTP_POST_VARS['feedback'])) ? '' : stripslashes(trim(htmlspecialchars($HTTP_POST_VARS['feedback'])));
$attachment     = (!isset($HTTP_POST_FILES['attachment']['name'])) ? '' : basename($HTTP_POST_FILES['attachment']['name']);
$code           = (!isset($HTTP_POST_VARS['code'])) ? '' : htmlspecialchars(trim($HTTP_POST_VARS['code']));

<a name="diff" id="c9"><span class="HDAdded">$script_path        = preg_replace('/^\/?(.*?)\/?$/', '\1', trim($board_config['script_path']));
$script_name        = ($script_path != '') ? $script_path . '/contact.'.$phpEx : 'contact.'.$phpEx;

$server_name        = trim($board_config['server_name']);
</span></a>$server_protocol    = ($board_config['cookie_secure']) ? 'https://' : 'http://';
$server_port        = ($board_config['server_port'] &lt;&gt; 80) ? ':' . trim($board_config['server_port']) <a name="diff" id="c10"><span class="HDDeleted">: '</span></a><span class="HDAdded">. '/' : '/</span>';
<span class="HDAdded">$server_url     = $server_protocol . $server_name . $server_port;
</span>
$timedate       = date("D M d, Y g:ia");
$CF_general_message = 0;

//
// "Quick Delete" an Attachment
//
if(isset($HTTP_GET_VARS['delete']))
{
    if($contact_config['contact_delete'] == 0)
    {
        message_die(GENERAL_ERROR, $lang['QDelete_disabled']);
    }
    else
    {
        include($phpbb_root_path . 'includes/functions_contact.'.$phpEx);
        exit;
    }
}

//
// Start send script
//
if(isset($HTTP_POST_VARS['submit']))
{
    function error_check()
    {
        global $HTTP_POST_FILES<a name="diff" id="c11"><span class="HDAdded">, $lang, $phpEx</span></a>;
        global $<span class="HDDeleted">lang, $phpEx, $</span>CF_general_message<span class="HDAdded">, $CF_code_empty, $CF_code_wrong, $CF_ini_max</span>;
<span class="HDDeleted">        global $CF_code_empty, $CF_code_wrong, $CF_ini_max;
</span>        global $CF_illegal_ext, $CF_unknown_ext, $CF_image_error, $CF_image_zip;
        global $CF_rname_empty, $CF_email_empty, $CF_email_check, $CF_comments_empty, $CF_comments_limit;
        global $CF_attach_POST_error, $CF_attach_file_exists, $CF_attach_file_dud, $CF_attach_file_big;

        //
        // Lets check for Errors
        //
        if($CF_general_message == 1)
        {
            @unlink($HTTP_POST_FILES['attachment']['tmp_name']);
            message_die(GENERAL_ERROR, $lang['Contact_error'] . $CF_code_empty .
                $CF_code_wrong . $CF_attach_POST_error . $CF_illegal_ext . $CF_unknown_ext .
                $CF_rname_empty . $CF_email_empty . $CF_email_check . $CF_comments_empty .
                $CF_comments_limit . $CF_attach_file_exists . $CF_attach_file_dud .
                $CF_attach_file_big . $CF_image_error . $CF_image_zip .
                sprintf($lang['Click_return_form'], "&lt;a href=\"contact.$phpEx\" onclick=\"history.back(-1); return false;\"&gt;", "&lt;/a&gt;"));
        }
    }

    //
    // Flood Control
    //
    if($contact_config['contact_flood_limit'] != 0)
    {
        $sql = "SELECT send_time, ip_address
            FROM " . CONTACT_TABLE . "
            WHERE ip_address = '$user_ip'
        ORDER BY send_time DESC";
        $result = $db-&gt;sql_query($sql);

        if(!$db-&gt;sql_query($sql))
        {
            message_die(GENERAL_ERROR, <a name="diff" id="c12"><span class="HDDeleted">"</span></a><span class="HDAdded">'</span>Failed to retrieve flood information<span class="HDDeleted">", ""</span><span class="HDAdded">', ''</span>, __LINE__, __FILE__, $sql);
        }
        $row = $db-&gt;sql_fetchrow($result);
<a name="diff" id="c13"><span class="HDAdded">
</span></a>        $time_left = round(intval($row['send_time'] - time()) / intval(60) / intval(60));

        if($row['ip_address'] == $user_ip &amp;&amp; $row['send_time'] - time() &gt; 0)
        {
            message_die(GENERAL_ERROR, sprintf($lang['Flood_limit'], $time_left));
        }
    }

    //
    // Captcha Code
    //
    if(extension_loaded('gd'))
    {
        if($contact_config['contact_captcha'] == 1)
        {
            @session_start();

            if(@ini_get('register_globals') == '0' || strtolower(@ini_get('register_globals')) == 'off')
            {
                if(isset($HTTP_SESSION_VARS['randi']))
                {
                    $randi = substr($HTTP_SESSION_VARS['randi'],0,6);
                }
            }
            else
            {
                // Required for max PHP5 compatability
                if(isset($_SESSION['randi']))
                {
                    $randi = substr($_SESSION['randi'],0,6);
                }
            }

            if(empty($code))
            {
                $CF_code_empty = <a name="diff" id="c14"><span class="HDDeleted">"&lt;br /&gt;&lt;br /&gt;"</span></a><span class="HDAdded">$_br</span> . $lang['Code_Empty'];
                $CF_general_message = 1;
            }
            elseif($code != $randi)
            {
                $CF_code_wrong = <a name="diff" id="c15"><span class="HDDeleted">"&lt;br /&gt;&lt;br /&gt;"</span></a><span class="HDAdded">$_br</span> . $lang['Code_Wrong'];
                $CF_general_message = 1;
            }

            //
            // Clear session data to prevent image reuse
            //
            @session_destroy();
            unset($randi);
        }
    }

    //
    // Real Name Validator
    //
    if($contact_config['contact_require_rname'] == 1)
    {
        if(empty($real_name))
        {
            $CF_rname_empty = <a name="diff" id="c16"><span class="HDDeleted">"&lt;br /&gt;&lt;br /&gt;"</span></a><span class="HDAdded">$_br</span> . $lang['Rname-Empty'];
            $CF_general_message = 1;
        }
    }

    //
    // E-mail Validator
    //
    if($contact_config['contact_require_email'] == 1)
    {
        if(!empty($email))
        {
            if(!preg_match('/^[a-z0-9&amp;\'\.\-_\+]+@[a-z0-9\-äöü]+\.([a-z0-9\-äöü]+\.)*?[a-z]+$/is', $email)) 
            {
                $CF_email_check = <a name="diff" id="c17"><span class="HDDeleted">"&lt;br /&gt;&lt;br /&gt;"</span></a><span class="HDAdded">$_br</span> . $lang['Email-Check'];
                $CF_general_message = 1;
            }
        }
        else
        {
            $CF_email_empty = <a name="diff" id="c18"><span class="HDDeleted">"&lt;br /&gt;&lt;br /&gt;"</span></a><span class="HDAdded">$_br</span> . $lang['Email-Empty'];
            $CF_general_message = 1;
        }
    }

    //
    // Comments Validator
    //
    if($contact_config['contact_require_comments'] == 1)
    {
        if(empty($comments))
        {
            $CF_comments_empty = <a name="diff" id="c19"><span class="HDDeleted">"&lt;br /&gt;&lt;br /&gt;"</span></a><span class="HDAdded">$_br</span> . $lang['Comments-Empty'];
            $CF_general_message = 1;
        }
    }

    if($contact_config['contact_char_limit'] &gt; 0)
    {
        if(strlen(trim($comments)) &gt; $contact_config['contact_char_limit'])
        {
            $CF_comments_limit = <a name="diff" id="c20"><span class="HDDeleted">"&lt;br /&gt;&lt;br /&gt;"</span></a><span class="HDAdded">$_br</span> . $lang['Comments_exceeded'];
            $CF_general_message = 1;
        }
    }
    // Stage 1
    error_check();

    $CF_attach_success = '';
    if($contact_config['contact_permit_attachments'] == 1)
    {
<a name="diff" id="c21"><span class="HDDeleted">        //
</span></a><span class="HDDeleted">        // Filename Hash option
        //
        if($contact_config['contact_hash'] == 0)
        {
            //
            // Normal Filenames
            //
            $attachment = !empty($attachment) ? strtolower(urlencode($HTTP_POST_FILES['attachment']['name'])) : '';
            $attach = $server_protocol . $board_config['server_name'] . $server_port . $board_config['script_path'] . $contact_config['contact_file_root'] . "/" . decode_ip($user_ip) . "/" . $attachment;
        }
        else
        {
            //
            // MD5 Filenames
            //
            $upload = strtolower(urlencode($HTTP_POST_FILES['attachment']['name']));

            // Get the file extension first
            $extn = substr(strrchr($upload, "."), 1);

            // Generate a random Filename
            $attachment = !empty($attachment) ? strtolower(md5(mt_rand() * time())  . "." . $extn) : '';
            $attach = $server_protocol . $board_config['server_name'] . $server_port . $board_config['script_path'] . $contact_config['contact_file_root'] . "/" . decode_ip($user_ip) . "/" . $attachment;
        }

        $delete_link = sprintf("\n" . $lang['Remove_file'], $server_protocol . $board_config['server_name'] .
            $server_port . $board_config['script_path'] . "contact." . $phpEx . "?delete=" . decode_ip($user_ip) . "/" . $attachment . "\n");

        //
        // Was there an attachment? Yes? Then lets process it.
        //
        if(empty($attachment))
        {
            $attach = $lang['Empty'];
            $delete_link = $lang['Empty'];
        }
        else
        {
            $filename = $HTTP_POST_FILES['attachment']['name'];
            $ext = strrchr(strtolower($filename), ".");

            //
            // Banned extentions
            //
            $blacklist = array( 'php', 'php3', 'php4', 'php5', 'php6', 'js', 'jse', 'htm', 'html', 'htaccess',
                        'ini', 'css', 'jar', 'shtm', 'shtml', 'dhtml', 'dhtml', 'cgi', 'asp',
                        'vbs', 'vb', 'vbe', 'pl', 'phtml', 'inc', 'xml', 'asmx', 'txt', 'doc', 'xls',
                        'exe', 'bat', 'com', 'cmd', 'ws', 'wsf', 'scr', 'shs', 'pif', 'hta', 'lnk' );
            //
            // Permitted extensions
            //
            $whitelist = array( 'zip', 'bmp', 'gif', 'jpg', 'jpeg', 'png', 'tiff', 'swf', 'psd' );

            if(in_array(trim($ext, '.'), $blacklist))
            {
                $CF_illegal_ext = "&lt;br /&gt;&lt;br /&gt;" . sprintf($lang['Illegal_ext'], $ext) . "&lt;br /&gt;" . $lang['zip_advise'];
                $CF_general_message = 1;
            }
            elseif(!in_array(trim($ext, '.'), $whitelist))
            {
                $CF_unknown_ext = "&lt;br /&gt;&lt;br /&gt;" . sprintf($lang['Unknown_ext'], $ext) . "&lt;br /&gt;" . $lang['zip_advise'];
                $CF_general_message = 1;
            }
            // Stage 2
            error_check();

            //
            // Extension safe - proceed with upload
            //
            if(($HTTP_POST_FILES['attachment']['size'] &gt; intval($contact_config['contact_max_file_size'] * 1024)) || ($HTTP_POST_FILES['attachment']['error'] == 1))
            {
                $CF_attach_file_big = "&lt;br /&gt;&lt;br /&gt;" . sprintf($lang['Attach-Too_big'], $contact_config['contact_max_file_size']) . "&lt;br /&gt;" . $lang['zip_advise'];
                $CF_general_message = 1;
            }
            elseif(($HTTP_POST_FILES['attachment']['error'] == 3) || ($HTTP_POST_FILES['attachment']['error'] == 6))
            {
                $CF_attach_POST_error = "&lt;br /&gt;&lt;br /&gt;" . $lang['POST_ERROR'];
                $CF_general_message = 1;
            }
            elseif(($HTTP_POST_FILES['attachment']['size'] == 0) || ($HTTP_POST_FILES['attachment']['error'] == 4))
            {
                $CF_attach_file_dud = "&lt;br /&gt;&lt;br /&gt;" . $lang['Attach_dud'];
                $CF_general_message = 1;
            }
            elseif(file_exists(@phpbb_realpath($phpbb_root_path . $contact_config['contact_file_root'] . "/" . decode_ip($user_ip) . "/" . $attachment)))
            {
                $CF_attach_file_exists = "&lt;br /&gt;&lt;br /&gt;" . $lang['Attach-File_exists'];
                $CF_general_message = 1;
            }
            // Stage 3
            error_check();

            //
            // Image Types
            //
            $imfilename = $HTTP_POST_FILES['attachment']['name'];

            $image_types = array( 'bmp', 'gif', 'jpg', 'jpeg', 'png', 'tiff', 'swf', 'psd' );
            $imext = strrchr(strtolower($imfilename), ".");

            if(in_array(trim($imext, '.'), $image_types))
            {
                list($width, $height, $type) = @getimagesize($HTTP_POST_FILES['attachment']['tmp_name']);

                if(intval($width) &gt; 0 &amp;&amp; intval($height) &gt; 0)
                {
                    switch ($type)
                    {
                        // GIF
                        case 1:
                            if($imext != '.gif')
                            {
                                $CF_image_error = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_error'];
                                $CF_general_message = 1;
                            }
                            break;

                        // JPG, JPC, JP2, JPX, JB2
                        case 2:
                        case 9:
                        case 10:
                        case 11:
                        case 12:
                            if($imext != '.jpg' &amp;&amp; $imext != '.jpeg')
                            {
                                $CF_image_error = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_error'];
                                $CF_general_message = 1;
                            }
                            break;

                        // PNG
                        case 3:
                            if($imext != '.png')
                            {
                                $CF_image_error = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_error'];
                                $CF_general_message = 1;
                            }
                            break;

                        // SWF
                        case 4:
                            if($imext != '.swf')
                            {
                                $CF_image_error = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_error'];
                                $CF_general_message = 1;
                            }
                            elseif($imext == '.swf')
                            {
                                $CF_image_zip = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_zip'];
                                $CF_general_message = 1;
                            }
                            break;

                        // PSD
                        case 5:
                            if($imext != '.psd')
                            {
                                $CF_image_error = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_error'];
                                $CF_general_message = 1;
                            }
                            elseif($imext == '.psd')
                            {
                                $CF_image_zip = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_zip'];
                                $CF_general_message = 1;
                            }
                            break;

                        // BMP
                        case 6:
                            if($imext != '.bmp')
                            {
                                $CF_image_error = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_error'];
                                $CF_general_message = 1;
                            }
                            elseif($imext == '.bmp')
                            {
                                $CF_image_zip = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_zip'];
                                $CF_general_message = 1;
                            }
                            break;

                        // TIFF's
                        case 7:
                        case 8:
                            if($imext != '.tiff')
                            {
                                $CF_image_error = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_error'];
                                $CF_general_message = 1;
                            }
                            elseif($imext == '.tiff')
                            {
                                $CF_image_zip = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_zip'];
                                $CF_general_message = 1;
                            }
                            break;

                        default:
                                $CF_image_error = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_error'];
                                $CF_general_message = 1;
                    }
                }
                else
                {
                    // XSS?
                    $CF_image_error = "&lt;br /&gt;&lt;br /&gt;" . $lang['Image_error'];
                    $CF_general_message = 1;
                }
            }
            // Stage 4
            error_check();

            if(!file_exists(@phpbb_realpath($phpbb_root_path . $contact_config['contact_file_root'] . "/" . decode_ip($user_ip))) )
            {
                if(!file_exists(@phpbb_realpath($phpbb_root_path . $contact_config['contact_file_root'] . "/")))
                {
                    @mkdir($contact_config['contact_file_root'] . "/", 0755);

                    $fd =   @fopen($contact_config['contact_file_root'] . "/index.html", 'a');
                        @fclose($fd);
                }
                @mkdir($contact_config['contact_file_root'] . "/" . decode_ip($user_ip), 0755);
            }

            if(@is_uploaded_file($HTTP_POST_FILES['attachment']['tmp_name']))
            {
                @move_uploaded_file($HTTP_POST_FILES['attachment']['tmp_name'],  $contact_config['contact_file_root'] . "/" . decode_ip($user_ip) . "/" . $attachment);

                $fa =   @fopen($contact_config['contact_file_root'] . "/" . decode_ip($user_ip) . "/index.html", 'a');
                    @fclose($fa);

                $CF_attach_success = "&lt;br /&gt;&lt;br /&gt;" . $lang['Attach-Uploaded'];
            }
            else
            {
                @unlink($attach);
                $CF_attach_POST_error = "&lt;br /&gt;&lt;br /&gt;" . $lang['POST_ERROR'];
                $CF_general_message = 1;
            }
        }
</span><span class="HDAdded">        require($phpbb_root_path . 'includes/contact_attach.'.$phpEx);
</span>    }
    // Stage 5
    error_check();

    //
    // I<a name="diff" id="c22"><span class="HDDeleted">f</span></a><span class="HDAdded">ndicate</span> any fields <span class="HDDeleted">are empty that aren't required, lets tell the recipient that</span><span class="HDAdded">that weren't completed</span>
    //
    if(empty($real_name) &amp;&amp; $contact_config['contact_require_rname'] == 0)
    {
        $real_name = $lang['Empty'];
    }

    if(empty($email) &amp;&amp; $contact_config['contact_require_email'] == 0)
    {
        $email = $lang['Empty'];
    }

    if(empty($comments) &amp;&amp; $contact_config['contact_require_comments'] == 0)
    {
        $comments = $lang['Empty'];
    }

<a name="diff" id="c23"><span class="HDAdded">    if($contact_config['contact_permit_attachments'] == 0)
    {
        $attach = '--';
        $delete_link = '';
    }

</span></a>    //
    // Change "Anonymous" to "Guest"
    //
    $user_name = ($userdata['user_id'] == ANONYMOUS) ? $lang['Guest'] : $userdata['username'];

    //
    // Set the Subject
    // NB: not used <a name="diff" id="c24"><span class="HDDeleted">-</span></a><span class="HDAdded">if</span> email/contact.tpl has 'Subject:' hard-coded
    //
    $subject = trim(stripslashes($lang['Feedback']));

    $sql = "SELECT user_lang
            FROM " . USERS_TABLE . "
            WHERE user_id = 2";
<a name="diff" id="c25"><span class="HDAdded">
</span></a>    if(!<span class="HDDeleted">(</span>$result = $db-&gt;sql_query($sql<span class="HDDeleted">)</span>))
    {
        message_die(CRITICAL_ERROR, <a name="diff" id="c26"><span class="HDDeleted">"</span></a><span class="HDAdded">'</span>Could not query recipient information<span class="HDDeleted">", ""</span><span class="HDAdded">', ''</span>, __LINE__, __FILE__, $sql);
    }
    $row = $db-&gt;sql_fetchrow($result);

    //
    // Send the e-mail
    //
    include($phpbb_root_path . 'includes/emailer.'.$phpEx);

    $emailer = new emailer($board_config['smtp_delivery']);
    $emailer-&gt;from($board_config['board_email']);
    $emailer-&gt;replyto($board_config['board_email']);

    $email_headers  = 'X-AntiAbuse: Board Servername - ' . $board_config['server_name'] . "\n";
    $email_headers .= 'X-AntiAbuse: User ID - ' . $userdata['user_id'] . "\n";
    $email_headers .= 'X-AntiAbuse: Username - ' . $userdata['username'] . "\n";
    $email_headers .= 'X-AntiAbuse: User IP - ' . decode_ip($user_ip) . "\n";

    empty($contact_config['contact_admin_email']) ? $emailer-&gt;email_address($board_config['board_email']) : $emailer-&gt;email_address($contact_config['contact_admin_email']);

    $emailer-&gt;extra_headers($email_headers);
    $emailer-&gt;use_template('contact', $row['user_lang']);
    $emailer-&gt;set_subject($subject);

    $emailer-&gt;assign_vars(array(
        'REAL_NAME' =&gt; $real_name,
        'USERNAME' =&gt; $user_name,
        'EMAIL' =&gt; $email,
        'COMMENTS' =&gt; $comments,
        'ATTACHMENT' =&gt; $attach,
        'DELETE' =&gt; ($contact_config['contact_delete'] == 1) ? $delete_link : '',

        'USER_IP' =&gt; decode_ip($user_ip),
        'TIMEDATE' =&gt; $timedate,
        'SITENAME' =&gt; $board_config['sitename'])
    );

    $emailer-&gt;send();
    $emailer-&gt;reset();

    //
<a name="diff" id="c27"><span class="HDAdded">    // Send "Thank You" E-mail?
    //
    if($contact_config['contact_thankyou'] != 0)
    {
        include($phpbb_root_path . 'includes/contact_extend.'.$phpEx);
    }

    //
</span></a>    // SQL Time
    //
    $wait_time = time() + intval($contact_config['contact_flood_limit'] * 60) * intval(60);
<a name="diff" id="c28"><span class="HDAdded">
</span></a>    $sql = "INSERT INTO " . CONTACT_TABLE . "
        VALUES ('$user_ip', '$wait_time')";
    $result = $db-&gt;sql_query($sql);

    if(!$db-&gt;sql_query($sql))
    {
        message_die(GENERAL_ERROR, <a name="diff" id="c29"><span class="HDDeleted">"</span></a><span class="HDAdded">'</span>Failed to insert user information<span class="HDDeleted">", ""</span><span class="HDAdded">', ''</span>, __LINE__, __FILE__, $sql);
    }

    //
    // No Errors
    //
    if($CF_general_message == 0)
    {
        if($contact_config['contact_storage'] == 1)
        {
            $send_time = time();
            $getfile = (!empty($attachment)) ? $contact_config['contact_file_root'] . "/" . decode_ip($user_ip) . "/" . $attachment : '';

            $sql =  "INSERT INTO " . CONTACT_MSGS_TABLE . " (sendtime, username, realname, email, ip, message, <a name="diff" id="c30"><span class="HDAdded">up</span></a>file)
                VALUES ($send_time, '$user_name', '" . str_replace("\'", "''", $real_name) . "',
                    '" . str_replace("\'", "''", $email) . "', '$user_ip', '" . addslashes(str_replace("\'", "''", $comments)) . "', '" . str_replace("\'", "''", $getfile) . "')";
<a name="diff" id="c31"><span class="HDAdded">
</span></a>                if(!$db-&gt;sql_query($sql, END_TRANSACTION))
                {
                    message_die(GENERAL_ERROR, <a name="diff" id="c32"><span class="HDDeleted">"</span></a><span class="HDAdded">'</span>Could not update Message Log<span class="HDDeleted">", ""</span><span class="HDAdded">', ''</span>, __LINE__, __FILE__, $sql);
                }
        }

        message_die(GENERAL_MESSAGE, $lang['Contact_success'] . $CF_attach_success  . <a name="diff" id="c33"><span class="HDDeleted">"&lt;br /&gt;&lt;br /&gt;"</span></a><span class="HDAdded">$_br</span> . sprintf($lang['Click_return_index'], "&lt;a href=" . append_sid('index.'.$phpEx) . "&gt;", "&lt;/a&gt;"));
    }
}

//
// End send script
//

//
// Change "Anonymous" to "Guest"
//
$user_name = ($userdata['user_id'] == ANONYMOUS) ? $lang['Guest'] : $userdata['username'];

//
// Check if "Real Name" is required
//
$rname = ($contact_config['contact_require_rname'] == 1) ? $lang['Rname_require'] : $lang['Real_name'];

//
// Check if "E-mail" is required
//
$email = ($contact_config['contact_require_email'] == 1) ? $lang['E-mail_require'] : $lang['E-mail'];

//
// Check if "Comments" are required
//
$comments = ($contact_config['contact_require_comments'] == 1) ? $lang['Comments_require'] : $lang['Comments'];

//
// Pruning
//
if($contact_config['contact_prune'] == 1)
{
    $send_time = time();
<a name="diff" id="c34"><span class="HDAdded">
</span></a>    $sql = "DELETE FROM " . CONTACT_TABLE . "
        WHERE send_time &lt;= '$send_time'";
<a name="diff" id="c35"><span class="HDDeleted">    $result = $db-&gt;sql_query($sql);
</span></a>
    if(!$<a name="diff" id="c36"><span class="HDAdded">result = $</span></a>db-&gt;sql_query($sql))
    {
        message_die(GENERAL_ERROR, <a name="diff" id="c37"><span class="HDDeleted">"</span></a><span class="HDAdded">'</span>Failed to initiate pruning<span class="HDDeleted">", ""</span><span class="HDAdded">', ''</span>, __LINE__, __FILE__, $sql);
    }
}

//
// Generate the Page
//
$page_title = $lang['Contact'];
include($phpbb_root_path . 'includes/page_header.'.$phpEx);

$template-&gt;set_filenames(array( 
    'body' =&gt; 'contact_body.tpl') 
);

$template-&gt;assign_vars(array(
    'L_CONTACT_FORM' =&gt; $lang['Contact_form'],
    'L_INTRODUCTION' =&gt; $lang['Contact_intro'],

    'L_REAL_NAME' =&gt; $rname,
    'L_REAL_NAME_EXPLAIN' =&gt; $lang['Real_name_explain'],

    'L_EMAIL' =&gt; $email,
    'L_EXPLAIN_EMAIL' =&gt; $lang['Explain_email'],

    'L_COMMENTS' =&gt; $comments,
    'L_COMMENTS_EXPLAIN' =&gt; $lang['Comments_explain'],
    'L_COMMENTS_LIMIT' =&gt; ($contact_config['contact_char_limit'] &gt; 0) ? sprintf($lang['Comments_limit'], $contact_config['contact_char_limit']) : '',

    'L_ATTACHMENT' =&gt; $lang['Attachment'],
    'L_ATTACHMENT_EXPLAIN' =&gt; sprintf($lang['Attachment_explain'], $contact_config['contact_max_file_size']),

    'L_FLOOD_EXPLAIN' =&gt; ($contact_config['contact_flood_limit'] &gt; 0) ? sprintf($lang['Flood_explain'], $contact_config['contact_flood_limit'], ($contact_config['contact_flood_limit'] &lt;&gt; 1) ? $lang['hours'] : $lang['hour']) : '',

    'L_FIELDS_REQUIRED' =&gt; $lang['Fields_required'],
    'L_NOTIFY_IP' =&gt; $lang['Notify_IP'],

    'L_CHARS' =&gt; $lang['Chars'],

    'L_CAPTCHA' =&gt; $lang['Captcha_code'],
    'L_CAPTCHA_EXPLAIN' =&gt; $lang['Captcha_code_explain'],

    'L_SUBMIT' =&gt; $lang['Submit'],
    'L_RESET' =&gt; $lang['Reset'],

    'USERNAME' =&gt; $user_name,
    'CAPTCHA' =&gt; 'includes/contact_captcha.'.$phpEx,

    'S_FORM_ENCTYPE' =&gt; 'multipart/form-data',
    'S_SUBMIT_ACTION' =&gt; append_sid('contact.'.$phpEx))
);

//
// Permit Attachments
//
$attach_auth = 0;
if(!$userdata['session_logged_in'])
{
    $attach_auth = ($contact_config['contact_auth_guest'] == 1) ? 1 : 0;
}
else
{
    switch ($userdata['user_level'])
    {
        case USER:
            $attach_auth = ($contact_config['contact_auth_user'] == 1) ? 1 : 0;
            break;

        case MOD:
            $attach_auth = ($contact_config['contact_auth_mod'] == 1) ? 1 : 0;
            break;

        case ADMIN:
            $attach_auth = ($contact_config['contact_auth_admin'] == 1) ? 1 : 0;
            break;

        default:
            $attach_auth = ($contact_config['contact_auth_guest'] == 1) ? 1 : 0;
    }
}

if($contact_config['contact_permit_attachments'] == 1 &amp;&amp; $attach_auth == 1)
{
    $template-&gt;assign_block_vars('permit_attachments', array());
}

if($contact_config['contact_captcha'] == 1 &amp;&amp; extension_loaded('gd'))
{
    $template-&gt;assign_block_vars('captcha', array());
}

$template-&gt;pparse('body');
include($phpbb_root_path . 'includes/page_tail.'.$phpEx);

?&gt;</span>
</pre>
</body>
<SCRIPT LANGUAGE="JavaScript" TYPE="text/javascript">
<!--
var newWind;
function putJumpCode(){
	var cnt = 38;
	newWind.document.write('<html>\n');
	newWind.document.write('<title>HtmlDiff Navigation</title>\n');
	newWind.document.write('<body>\n');
	newWind.document.write('<form name="jump">\n');
	newWind.document.write('<input type="button" value=" |&lt; " name="First" onclick=goto_first(this.form)>&nbsp;')
	newWind.document.write('<input type="button" value=" &lt; " name="Prev" onclick=goto_prev(this.form)>&nbsp;&nbsp;\n');
	newWind.document.write('<select name=url onchange=menu_goto(this.form)> \n');
	for (var i=0; i<cnt ;i++ ) {
		newWind.document.write('<option value="#c'+i+'">Change #'+(i+1)+ '</option> \n');
		}
	newWind.document.write('');
	newWind.document.write('</select>&nbsp;&nbsp;\n');
	newWind.document.write('<input type="button" value=" &gt; " name="Next"\n');
	newWind.document.write('onclick=goto_next(this.form)>\n');
	newWind.document.write('<input type="button" value=" &gt| " name="Last"\n');
	newWind.document.write('onclick=goto_last(this.form)>\n');
	newWind.document.write('</form>\n');
	newWind.document.write('');
	newWind.document.write('<form method="POST">\n');
	newWind.document.write('<p align="center"><i><font size="3">Generated\n');
	newWind.document.write('by <a href="http://www.ComponentSoftware.com/products/htmldiff" target="_blank">HtmlDiff</a> \n');
	newWind.document.write('</form>\n');
	newWind.document.write('</body>\n');
	newWind.document.write('</html>\n');
	newWind.document.write('<SCRIPT LANGUAGE="JavaScript" TYPE="text/javascript">\n');
	newWind.document.write('<!--\n');
	newWind.document.write('');
	newWind.document.write('var directCloseFlag=1;\n');
	newWind.document.write('');
	newWind.document.write('function menu_goto( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('  var baseurl = opener.location.href ;\n');
	newWind.document.write('  var idx = baseurl.indexOf("#");\n');
	newWind.document.write('  if (idx > -1) {\n');
	newWind.document.write('	baseurl = baseurl.slice(0, idx);\n');
	newWind.document.write('  }');
	newWind.document.write('  selecteditem = menuform.url.selectedIndex ;\n');
	newWind.document.write('  newurl = menuform.url.options[ selecteditem ].value ;\n');
	newWind.document.write('  if (newurl.length != 0) {\n');
	newWind.document.write('    	opener.top.location.href = baseurl + newurl ;\n');
	newWind.document.write('  }');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function goto_prev( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('	if(menuform.url.selectedIndex>0) menuform.url.selectedIndex--;\n');
	newWind.document.write('	menu_goto( menuform )\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function goto_first( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('	menuform.url.selectedIndex = 0;	\n');
	newWind.document.write('	menu_goto( menuform );\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function goto_last( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('	menuform.url.selectedIndex = menuform.url.options.length-1;	\n');
	newWind.document.write('	menu_goto( menuform );\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function goto_next( menuform )\n');
	newWind.document.write('{\n');
	newWind.document.write('	if(menuform.url.options.length > (menuform.url.selectedIndex+1))\n');
	newWind.document.write('	menuform.url.selectedIndex++;\n');
	newWind.document.write('	menu_goto( menuform )\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('function restore()\n');
	newWind.document.write('{\n');
	newWind.document.write('    	focus();\n');
	newWind.document.write('	menu_goto(jump);\n');
	newWind.document.write('}');
	newWind.document.write('');
	newWind.document.write('goto_first(jump)\n');
	newWind.document.write('//-->\n');
	newWind.document.write('<');
	newWind.document.write('/SCRIPT>\n');
}
function pop_navigate(){
var isOpen = false
try {
isOpen = (newWind != null) && (!newWind.closed)
} catch (e) {}
  if (!isOpen) {
    newWind =  window.open("" ,"HtmlDiffJumpWindow","width=270,height=40")
    if (newWind.opener == null) { // for Nav 2.0x
      newWind.opener = self // this creates and sets a new prop
    }	putJumpCode();
  
} 
else 
{	newWind.execScript("restore()", "JavaScript");
  }
}
function exit(){
var isOpen = false
try {
isOpen = (newWind != null) && (!newWind.closed)
} catch (e) {}
if (isOpen) {
	newWind.close();
  }
}
//--></SCRIPT></html>
